var BatchPerMaterial=pc.createScript("batchPerMaterial");BatchPerMaterial.prototype.initialize=function(){var e=[];this.entity.find((function(t){!0===t.enabled&&t.model&&t.model.meshInstances&&e.push(t.model)})),e.forEach(function(e){var t=this.app.assets.get(e.materialAsset);if(t){var a=t.resource.name,i=this.app.batcher.getGroupByName(a);i&&(e.batchGroupId=i.id)}}.bind(this)),this.app.batcher.generate()};var ClickGoToPoint=pc.createScript("clickGoToPoint");ClickGoToPoint.attributes.add("cameraEntity",{type:"entity",title:"Camera",description:"The active camera."}),ClickGoToPoint.attributes.add("pointEntity",{type:"entity",title:"Point"}),ClickGoToPoint.attributes.add("renderPath",{type:"boolean",default:!0,title:"Render Path"}),ClickGoToPoint.prototype.initialize=function(){this.controlCrowd=!0,this.spawnObstacles=[],this.pointEntity&&(this.pointEntity.enabled=!1),this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.mouseDown,this),this.app.touch&&this.app.touch.on(pc.EVENT_TOUCHSTART,this.touchStart,this),this.app.on("UI:buttonClicked",this.onButtonClicked,this)},ClickGoToPoint.prototype.mouseDown=function(t){BtnStates.clicked||t.button===pc.MOUSEBUTTON_LEFT&&this.doRaycast(t)},ClickGoToPoint.prototype.touchStart=function(t){BtnStates.clicked||(1==t.touches.length&&this.doRaycast(t.touches[0]),t.event.preventDefault())},ClickGoToPoint.prototype.doRaycast=function(t){var i=this.cameraEntity.getPosition(),o=this.cameraEntity.camera.screenToWorld(t.x,t.y,this.cameraEntity.camera.farClip),e=this.app.systems.rigidbody.raycastFirst(i,o);e&&this.navigate(e.point)},ClickGoToPoint.prototype.navigate=function(t){this.pointEntity&&(this.pointEntity.enabled=!0,this.pointEntity.setPosition(t.x,t.y+this.pointEntity.getLocalScale().y/2,t.z));const i=this.app.root.findByName("Crowd");if(this.controlCrowd)i.fire("OrestisPathfinding:moveCrowdTo",t,this.renderPath);else{const o=this.app.root.findByName("Player Solo");i.fire("OrestisPathfinding:moveAgentsTo",[o],t,this.renderPath)}const o=this.app.root.findByName("Player Solo");o.off("OrestisPathfinding:agentStopped",this.onAgentStopped,this),o.once("OrestisPathfinding:agentStopped",this.onAgentStopped,this)},ClickGoToPoint.prototype.onAgentStopped=function(t){console.log("OrestisPathfinding:agentStopped",t)},ClickGoToPoint.prototype.onButtonClicked=function(t,i){var o;if("Toggle Control"===t)return this.controlCrowd=!this.controlCrowd,o=this.controlCrowd?"Control Agent":"Control Crowd",void(i.findByName("Text").element.text=o.toUpperCase());if("Spawn Obstacle"===t){var e=new pc.Entity("Obstacle Cube");this.spawnObstacles.push(e),e.addComponent("model",{type:"box",materialAsset:this.app.assets.find("Mat Box Blue Dark")}),this.app.root.addChild(e),e.setPosition(pc.math.random(-20,20),13,pc.math.random(-20,20)),e.addComponent("collision",{type:"box"}),e.addComponent("rigidbody",{type:pc.BODYTYPE_DYNAMIC,mass:100,friction:1,restitution:0});var n=this;return onCollision=function(){var t=this.entity;!1!==e.rigidbody.linearVelocity.length()>.01||t.script||(t.collision.off("contact"),t.addComponent("script"),t.script.create("orestisObstacle",{attributes:{pathfinderEntity:n.app.root.findByName("Scene"),obstacleType:"box",boxExtents:[1,1,1],boxYAngle:t.getEulerAngles().y,initialState:!0}}),t.fire("OrestisPathfinding:initializeObstacle"))},void e.collision.on("contact",onCollision)}if("Remove Obstacles"!==t){var s,a;if("Stop Agents"===t)return s=this.app.root.findByName("Crowd"),void(this.controlCrowd?s.fire("OrestisPathfinding:stopCrowd"):(a=this.app.root.findByName("Player Solo"),s.fire("OrestisPathfinding:stopAgents",[a])));if("Teleport Agent"===t)return s=this.app.root.findByName("Crowd"),a=this.app.root.findByName("Player Solo"),void s.fire("OrestisPathfinding:teleportAgentsTo",[a],new pc.Vec3(-7.18,2.14,-19.69));if("Toggle Navmesh"===t)return pathfinderEntity=this.app.root.findByName("Scene"),void(pathfinderEntity.script.orestisPathfinding.debugNavMesh=!pathfinderEntity.script.orestisPathfinding.debugNavMesh);if("Get Paths"!==t)if("Get Path"!==t)if("Random Point"!==t)if("Pause Pathfinding"!==t);else{const t=this.app.root.findByName("Crowd");t.script.orestisCrowd.isPaused=!t.script.orestisCrowd.isPaused}else this.app.root.findByName("Scene").fire("OrestisPathfinding:getRandomPointAround",new pc.Vec3(0,1.25,0),20,(t=>{this.navigate(t)}));else this.app.root.findByName("Scene").fire("OrestisPathfinding:findPath",this.app.root.findByName("Sphere1").getPosition(),this.app.root.findByName("Sphere2").getPosition(),(t=>{console.log(t)}));else{const t=[];this.app.root.findByName("Crowd").fire("OrestisPathfinding:getPath",t,(t=>{console.log(t)}))}}else this.spawnObstacles.forEach((function(t){t.destroy()}))};var TouchInput=pc.createScript("touchInput");TouchInput.attributes.add("orbitSensitivity",{type:"number",default:.4,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),TouchInput.attributes.add("distanceSensitivity",{type:"number",default:.2,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),TouchInput.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera,this.lastTouchPoint=new pc.Vec2,this.lastPinchMidPoint=new pc.Vec2,this.lastPinchDistance=0,this.orbitCamera&&this.app.touch&&(this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHCANCEL,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.on("destroy",(function(){this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHCANCEL,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this)})))},TouchInput.prototype.getPinchDistance=function(t,i){var o=t.x-i.x,n=t.y-i.y;return Math.sqrt(o*o+n*n)},TouchInput.prototype.calcMidPoint=function(t,i,o){o.set(i.x-t.x,i.y-t.y),o.scale(.5),o.x+=t.x,o.y+=t.y},TouchInput.prototype.onTouchStartEndCancel=function(t){var i=t.touches;1==i.length?this.lastTouchPoint.set(i[0].x,i[0].y):2==i.length&&(this.lastPinchDistance=this.getPinchDistance(i[0],i[1]),this.calcMidPoint(i[0],i[1],this.lastPinchMidPoint))},TouchInput.fromWorldPoint=new pc.Vec3,TouchInput.toWorldPoint=new pc.Vec3,TouchInput.worldDiff=new pc.Vec3,TouchInput.prototype.pan=function(t){var i=TouchInput.fromWorldPoint,o=TouchInput.toWorldPoint,n=TouchInput.worldDiff,h=this.entity.camera,c=this.orbitCamera.distance;h.screenToWorld(t.x,t.y,c,i),h.screenToWorld(this.lastPinchMidPoint.x,this.lastPinchMidPoint.y,c,o),n.sub2(o,i),this.orbitCamera.pivotPoint.add(n)},TouchInput.pinchMidPoint=new pc.Vec2,TouchInput.prototype.onTouchMove=function(t){var i=TouchInput.pinchMidPoint,o=t.touches;if(1==o.length){var n=o[0];this.orbitCamera.pitch-=(n.y-this.lastTouchPoint.y)*this.orbitSensitivity,this.orbitCamera.yaw-=(n.x-this.lastTouchPoint.x)*this.orbitSensitivity,this.lastTouchPoint.set(n.x,n.y)}else if(2==o.length){var h=this.getPinchDistance(o[0],o[1]),c=h-this.lastPinchDistance;this.lastPinchDistance=h,this.orbitCamera.distance-=c*this.distanceSensitivity*.1*(.1*this.orbitCamera.distance),this.calcMidPoint(o[0],o[1],i),this.pan(i),this.lastPinchMidPoint.copy(i)}};var KeyboardInput=pc.createScript("keyboardInput");KeyboardInput.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera},KeyboardInput.prototype.postInitialize=function(){this.orbitCamera&&(this.startDistance=this.orbitCamera.distance,this.startYaw=this.orbitCamera.yaw,this.startPitch=this.orbitCamera.pitch,this.startPivotPosition=this.orbitCamera.pivotPoint.clone())},KeyboardInput.prototype.update=function(t){this.orbitCamera&&this.app.keyboard.wasPressed(pc.KEY_SPACE)&&(this.orbitCamera.reset(this.startYaw,this.startPitch,this.startDistance),this.orbitCamera.pivotPoint=this.startPivotPosition)};var MouseInput=pc.createScript("mouseInput");MouseInput.attributes.add("orbitSensitivity",{type:"number",default:.3,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),MouseInput.attributes.add("distanceSensitivity",{type:"number",default:.15,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),MouseInput.prototype.initialize=function(){if(this.orbitCamera=this.entity.script.orbitCamera,this.orbitCamera){var t=this,onMouseOut=function(o){t.onMouseOut(o)};this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.addEventListener("mouseout",onMouseOut,!1),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.off(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.removeEventListener("mouseout",onMouseOut,!1)}))}this.app.mouse.disableContextMenu(),this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new pc.Vec2},MouseInput.fromWorldPoint=new pc.Vec3,MouseInput.toWorldPoint=new pc.Vec3,MouseInput.worldDiff=new pc.Vec3,MouseInput.prototype.pan=function(t){var o=MouseInput.fromWorldPoint,e=MouseInput.toWorldPoint,i=MouseInput.worldDiff,s=this.entity.camera,n=this.orbitCamera.distance;s.screenToWorld(t.x,t.y,n,o),s.screenToWorld(this.lastPoint.x,this.lastPoint.y,n,e),i.sub2(e,o),this.orbitCamera.pivotPoint.add(i)},MouseInput.prototype.onMouseDown=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!0;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!0}},MouseInput.prototype.onMouseUp=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!1;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!1}},MouseInput.prototype.onMouseMove=function(t){pc.app.mouse;this.lookButtonDown?(this.orbitCamera.pitch-=t.dy*this.orbitSensitivity,this.orbitCamera.yaw-=t.dx*this.orbitSensitivity):this.panButtonDown&&this.pan(t),this.lastPoint.set(t.x,t.y)},MouseInput.prototype.onMouseWheel=function(t){this.orbitCamera.distance-=t.wheel*this.distanceSensitivity*(.1*this.orbitCamera.distance),t.event.preventDefault()},MouseInput.prototype.onMouseOut=function(t){this.lookButtonDown=!1,this.panButtonDown=!1};var OrbitCamera=pc.createScript("orbitCamera");OrbitCamera.attributes.add("distanceMax",{type:"number",default:0,title:"Distance Max",description:"Setting this at 0 will give an infinite distance limit"}),OrbitCamera.attributes.add("distanceMin",{type:"number",default:0,title:"Distance Min"}),OrbitCamera.attributes.add("pitchAngleMax",{type:"number",default:90,title:"Pitch Angle Max (degrees)"}),OrbitCamera.attributes.add("pitchAngleMin",{type:"number",default:-90,title:"Pitch Angle Min (degrees)"}),OrbitCamera.attributes.add("inertiaFactor",{type:"number",default:0,title:"Inertia Factor",description:"Higher value means that the camera will continue moving after the user has stopped dragging. 0 is fully responsive."}),OrbitCamera.attributes.add("focusEntity",{type:"entity",title:"Focus Entity",description:"Entity for the camera to focus on. If blank, then the camera will use the whole scene"}),OrbitCamera.attributes.add("frameOnStart",{type:"boolean",default:!0,title:"Frame on Start",description:'Frames the entity or scene at the start of the application."'}),Object.defineProperty(OrbitCamera.prototype,"distance",{get:function(){return this._targetDistance},set:function(t){this._targetDistance=this._clampDistance(t)}}),Object.defineProperty(OrbitCamera.prototype,"pitch",{get:function(){return this._targetPitch},set:function(t){this._targetPitch=this._clampPitchAngle(t)}}),Object.defineProperty(OrbitCamera.prototype,"yaw",{get:function(){return this._targetYaw},set:function(t){this._targetYaw=t;var i=(this._targetYaw-this._yaw)%360;this._targetYaw=i>180?this._yaw-(360-i):i<-180?this._yaw+(360+i):this._yaw+i}}),Object.defineProperty(OrbitCamera.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(t){this._pivotPoint.copy(t)}}),OrbitCamera.prototype.focus=function(t){this._buildAabb(t,0);var i=this._modelsAabb.halfExtents,e=Math.max(i.x,Math.max(i.y,i.z));e/=Math.tan(.5*this.entity.camera.fov*pc.math.DEG_TO_RAD),e*=2,this.distance=e,this._removeInertia(),this._pivotPoint.copy(this._modelsAabb.center)},OrbitCamera.distanceBetween=new pc.Vec3,OrbitCamera.prototype.resetAndLookAtPoint=function(t,i){this.pivotPoint.copy(i),this.entity.setPosition(t),this.entity.lookAt(i);var e=OrbitCamera.distanceBetween;e.sub2(i,t),this.distance=e.length(),this.pivotPoint.copy(i);var a=this.entity.getRotation();this.yaw=this._calcYaw(a),this.pitch=this._calcPitch(a,this.yaw),this._removeInertia(),this._updatePosition()},OrbitCamera.prototype.resetAndLookAtEntity=function(t,i){this._buildAabb(i,0),this.resetAndLookAtPoint(t,this._modelsAabb.center)},OrbitCamera.prototype.reset=function(t,i,e){this.pitch=i,this.yaw=t,this.distance=e,this._removeInertia()},OrbitCamera.prototype.initialize=function(){var t=this,onWindowResize=function(){t._checkAspectRatio()};window.addEventListener("resize",onWindowResize,!1),this._checkAspectRatio(),this._modelsAabb=new pc.BoundingBox,this._buildAabb(this.focusEntity||this.app.root,0),this.entity.lookAt(this._modelsAabb.center),this._pivotPoint=new pc.Vec3,this._pivotPoint.copy(this._modelsAabb.center);var i=this.entity.getRotation();if(this._yaw=this._calcYaw(i),this._pitch=this._clampPitchAngle(this._calcPitch(i,this._yaw)),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._targetYaw=this._yaw,this._targetPitch=this._pitch,this.frameOnStart)this.focus(this.focusEntity||this.app.root);else{var e=new pc.Vec3;e.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(e.length())}this._targetDistance=this._distance,this.on("attr:distanceMin",(function(t,i){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:distanceMax",(function(t,i){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:pitchAngleMin",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:pitchAngleMax",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:focusEntity",(function(t,i){this.frameOnStart?this.focus(t||this.app.root):this.resetAndLookAtEntity(this.entity.getPosition(),t||this.app.root)})),this.on("attr:frameOnStart",(function(t,i){t&&this.focus(this.focusEntity||this.app.root)})),this.on("destroy",(function(){window.removeEventListener("resize",onWindowResize,!1)}))},OrbitCamera.prototype.update=function(t){var i=0===this.inertiaFactor?1:Math.min(t/this.inertiaFactor,1);this._distance=pc.math.lerp(this._distance,this._targetDistance,i),this._yaw=pc.math.lerp(this._yaw,this._targetYaw,i),this._pitch=pc.math.lerp(this._pitch,this._targetPitch,i),this._updatePosition()},OrbitCamera.prototype._updatePosition=function(){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0);var t=this.entity.getPosition();t.copy(this.entity.forward),t.scale(-this._distance),t.add(this.pivotPoint),this.entity.setPosition(t)},OrbitCamera.prototype._removeInertia=function(){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance},OrbitCamera.prototype._checkAspectRatio=function(){var t=this.app.graphicsDevice.height,i=this.app.graphicsDevice.width;this.entity.camera.horizontalFov=t>i},OrbitCamera.prototype._buildAabb=function(t,i){var e=0;if(t.model){var a=t.model.meshInstances;for(e=0;e<a.length;e++)0===i?this._modelsAabb.copy(a[e].aabb):this._modelsAabb.add(a[e].aabb),i+=1}for(e=0;e<t.children.length;++e)i+=this._buildAabb(t.children[e],i);return i},OrbitCamera.prototype._calcYaw=function(t){var i=new pc.Vec3;return t.transformVector(pc.Vec3.FORWARD,i),Math.atan2(-i.x,-i.z)*pc.math.RAD_TO_DEG},OrbitCamera.prototype._clampDistance=function(t){return this.distanceMax>0?pc.math.clamp(t,this.distanceMin,this.distanceMax):Math.max(t,this.distanceMin)},OrbitCamera.prototype._clampPitchAngle=function(t){return pc.math.clamp(t,-this.pitchAngleMax,-this.pitchAngleMin)},OrbitCamera.quatWithoutYaw=new pc.Quat,OrbitCamera.yawOffset=new pc.Quat,OrbitCamera.prototype._calcPitch=function(t,i){var e=OrbitCamera.quatWithoutYaw,a=OrbitCamera.yawOffset;a.setFromEulerAngles(0,-i,0),e.mul2(a,t);var s=new pc.Vec3;return e.transformVector(pc.Vec3.FORWARD,s),Math.atan2(s.y,-s.z)*pc.math.RAD_TO_DEG};var BtnStates=pc.createScript("btnStates");BtnStates.attributes.add("hoverAsset",{type:"asset",assetType:"texture"}),BtnStates.attributes.add("activeAsset",{type:"asset",assetType:"texture"}),BtnStates.clicked=!1,BtnStates.prototype.initialize=function(){this.activeNavMesh=0,this.originalTexture=this.entity.element.textureAsset,this.hovered=!1,this.entity.element.on("mouseenter",this.onEnter,this),this.entity.element.on("mousedown",this.onPress,this),this.entity.element.on("mouseup",this.onRelease,this),this.entity.element.on("mouseleave",this.onLeave,this),this.entity.element.on("touchstart",this.onPress,this),this.entity.element.on("touchend",this.onRelease,this)},BtnStates.prototype.onEnter=function(t){this.hovered=!0,t.element.textureAsset=this.hoverAsset,document.body.style.cursor="pointer"},BtnStates.prototype.onLeave=function(t){this.hovered=!1,t.element.textureAsset=this.originalTexture,document.body.style.cursor="default"},BtnStates.prototype.onPress=function(t){BtnStates.clicked=!0,t.element.textureAsset=this.activeAsset},BtnStates.prototype.onRelease=function(t){t.element.textureAsset=this.hovered?this.hoverAsset:this.originalTexture,this.app.fire("UI:buttonClicked",this.entity.name,this.entity),window.setTimeout((function(){BtnStates.clicked=!1}),100)};var HandleObstacles=pc.createScript("handleObstacles");HandleObstacles.prototype.initialize=function(){this.app.on("UI:buttonClicked",this.onButtonClicked,this)},HandleObstacles.prototype.onButtonClicked=function(t){if(-1!==t.indexOf("Obstacle")){var e=this.app.root.findByName("Obstacles").findByName(t);if(e){var s=e.script.orestisObstacle;s.updateObstacle(!s.state),e.orestisTween&&e.orestisTween.stop();var i=e.getPosition().clone();i.y+=s.state?-3:3,e.orestisTween=e.tween(e.getLocalPosition()).to(i,.5,pc.SineOut).start()}}};var GetAgentSpeed=pc.createScript("getAgentSpeed");GetAgentSpeed.prototype.initialize=function(){this.vec=new pc.Vec3,this.agentEntity=this.app.root.findByName("Player Solo"),this.orestisAgent=this.agentEntity.script.orestisAgent,this.agentIndex=void 0},GetAgentSpeed.prototype.update=function(t){var e=this.orestisAgent.crowd;if(e){this.agentIndex||(this.agentIndex=e.getAgentIndex(this.agentEntity));var i=e.getAgentVelocity(this.agentIndex,this.vec).length();this.entity.element.text="Agent Speed: "+i.toFixed(2)+"m/s"}this.app.keyboard.wasPressed(pc.KEY_R)&&(this.agentEntity.script.orestisAgent.maxSpeed=5===this.agentEntity.script.orestisAgent.maxSpeed?0:5)};!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,s){"use strict";var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const a=n(s(1)),d=n(s(2)),c=n(s(3)),l=n(s(5));new a.default,new d.default,new c.default,new l.default,console.log("Orestis 3D Pathfinding v2.2.3")},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=class{constructor(){this.createPcScript()}createPcScript(){const t=pc.createScript("orestisAgent");this.attachAttributes(t),t.prototype.initialize=function(){let t;this.agentId=void 0,this.crowd=void 0,pc.events.attach(this.entity),this.on("attr",(()=>{window.clearTimeout(t),t=window.setTimeout(this.updateAgentAttributes.bind(this),300)})),this.entity.on("OrestisPathfinding:updateAgentAttributes",this.updateAgentAttributes,this)},t.prototype.onAddAgent=function(t,e){this.agentId=t,this.crowd=e},t.prototype.updateAgentAttributes=function(){this.crowd.updateAgentParameters(this.agentId,{radius:this.radius,height:this.height,maxAcceleration:this.maxAcceleration,maxSpeed:this.maxSpeed,collisionQueryRange:this.collisionQueryRange,pathOptimizationRange:this.pathOptimizationRange,separationWeight:this.separationWeight,stopDistance:this.stopDistance,orientAgent:this.orientAgent,orientInertia:this.orientInertia})}}attachAttributes(t){t.attributes.add("radius",{type:"number",default:.5,min:0,title:"Radius",description:"Agent radius. [Limit: >= 0]"}),t.attributes.add("height",{type:"number",default:1,min:0,title:"Height",description:"Agent height. [Limit: >= 0]"}),t.attributes.add("maxAcceleration",{type:"number",default:1,min:0,title:"Max Acceleration",description:"Maximum allowed acceleration. [Limit: >= 0]"}),t.attributes.add("maxSpeed",{type:"number",default:1,min:0,title:"Max Speed",description:"Maximum allowed speed. [Limit: >= 0]"}),t.attributes.add("collisionQueryRange",{type:"number",default:.5,min:0,title:"Collision Query Range",description:"Defines how close a collision element must be before it is considered for steering behaviors. [Limits: > 0]"}),t.attributes.add("pathOptimizationRange",{type:"number",default:0,min:0,title:"Path Optimization Range",description:"The path visibility optimization range. [Limit: > 0]"}),t.attributes.add("separationWeight",{type:"number",default:1,min:0,title:"Separation Weight",description:"How aggressive the agent manager should be at avoiding collisions with this agent. [Limit: >= 0]"}),t.attributes.add("stopDistance",{type:"number",default:0,title:"Stop Distance",description:"The distance from the path end point this agent should stop at. If 0.0 is provided the agent will reach as close as possible to the end point."}),t.attributes.add("orientInertia",{type:"number",default:.1,title:"Orient Inertia",description:"How smoothly the agent entity will rotate to orient itself."}),t.attributes.add("orientAgent",{type:"boolean",default:!0,title:"Orient Agent",description:"If selected the agent entity will automatically orient itself on the Y axis to look at the next point on the path."})}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=class{constructor(){this.createPcScript()}createPcScript(){const t=pc.createScript("orestisObstacle");this.attachAttributes(t),t.prototype.initialize=function(){this.pathfinder=void 0,this.obstacleRef=void 0,this.state=this.initialState,this.obstaclePos=this.entity.getPosition().clone(),this.entity.on("OrestisPathfinding:initializeObstacle",this.initializeObstacle,this),this.on("state",(function(t){this.updateObstacle(t)}),this)},t.prototype.initializeObstacle=function(t){var e,s,n;if(t)this.pathfinder=t;else{if(!this.pathfinderEntity)return;this.pathfinder=null===(n=null===(s=null===(e=this.pathfinderEntity)||void 0===e?void 0:e.script)||void 0===s?void 0:s.orestisPathfinding)||void 0===n?void 0:n.pathfinder}this.updateObstacle(this.state)},t.prototype.updateObstacle=function(t){this.state=!0===t;const e=this.pathfinder;if(!0===t){let t;switch(this.obstacleType){case"box":t=e.addBoxObstacle(this.obstaclePos,this.boxExtents,this.boxYAngle*pc.math.DEG_TO_RAD);break;case"cylinder":t=e.addCylinderObstacle(this.obstaclePos,this.cylinderRadius,this.cylinderHeight)}this.obstacleRef=t}else e.removeObstacle(this.obstacleRef),this.obstacleRef=void 0,e.navMesh.update()}}attachAttributes(t){t.attributes.add("pathfinderEntity",{type:"entity",title:"Pathfinder",description:"Drag and drop the pathfinder entity this obstacle should interact with. Updating this requires regenerating the navmesh or reloading your app"}),t.attributes.add("obstacleType",{type:"string",default:"box",title:"Obstacle Type",description:"Set the type of the obstacle shape.",enum:[{Box:"box"},{Cylinder:"cylinder"}]}),t.attributes.add("boxExtents",{type:"vec3",default:[1,1,1],title:"Box Extents",description:"The box extents on each axis."}),t.attributes.add("boxYAngle",{type:"number",default:0,min:0,max:360,title:"Box Y Angle",description:"The angle of the box orientation on the Y axis."}),t.attributes.add("cylinderRadius",{type:"number",default:1,min:0,title:"Cylinder Radius",description:"The cylinder radius."}),t.attributes.add("cylinderHeight",{type:"number",default:2,min:0,title:"Cylinder Height",description:"The cylinder height."}),t.attributes.add("initialState",{type:"boolean",default:!0,title:"Initial State",description:"If the obstacle will be enabled or disabled when the navmesh is generated."})}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=s(4);e.default=class{constructor(){this.createPcScript()}createPcScript(){const t=pc.createScript("orestisCrowd");this.attachAttributes(t),t.prototype.initialize=function(){this.pathfinder=void 0,this.crowd=void 0,this.agentsList=void 0,this.activeAgents=void 0,this.debugLines=!1,this.debugPath=void 0,this.debugColors=void 0,this.activeDestination=void 0,this.debugLineColor=new pc.Color(1,1,1,.5),this.isPaused=!1,pc.events.attach(this.entity),this.entity.on("OrestisPathfinding:moveCrowdTo",(function(t,e){this.moveCrowdTo(null,t,e)}),this),this.entity.on("OrestisPathfinding:moveAgentsTo",(function(t,e,s){this.moveCrowdTo(t,e,s)}),this),this.entity.on("OrestisPathfinding:stopCrowd",(function(){this.stopCrowd(null)}),this),this.entity.on("OrestisPathfinding:stopAgents",(function(t){this.stopCrowd(t)}),this),this.entity.on("OrestisPathfinding:teleportAgentsTo",(function(t,e,s){this.teleportAgentsTo(t,e)}),this),this.entity.on("OrestisPathfinding:getPath",(function(t,e){"function"==typeof e&&e(this.getPath(t))}),this),this.on("attr",(function(t,e){this.initializeCrowd()}))},t.prototype.initializeCrowd=function(t){t&&(this.pathfinder=t),this.crowd&&this.crowd.destroy(),this.crowd=new n.OrestisCrowd(this,this.pathfinder,this.maxAgents,this.maxAgentRadius),this.assignAgents()},t.prototype.destroyCrowd=function(){this.crowd&&this.crowd.destroy(),this.crowd=void 0},t.prototype.assignAgents=function(){this.agentsList={},this.agents.forEach((t=>{var e;const s=null===(e=null==t?void 0:t.script)||void 0===e?void 0:e.orestisAgent;if(!s)return!0;const n=this.crowd.addAgent(t,{radius:s.radius,height:s.height,maxAcceleration:s.maxAcceleration,maxSpeed:s.maxSpeed,collisionQueryRange:s.collisionQueryRange,pathOptimizationRange:s.pathOptimizationRange,separationWeight:s.separationWeight,stopDistance:s.stopDistance,orientAgent:s.orientAgent,orientInertia:s.orientInertia});s.onAddAgent(n,this.crowd),this.agentsList[t._guid]=n}))},t.prototype.moveCrowdTo=function(t,e,s){if(this.debugLines=s,!this.crowd)return;let n,a;t?(a=[],t.forEach((t=>{a.push(this.agentsList[t._guid])}))):a=this.crowd.getAgents(),a.forEach((t=>{n=this.pathfinder.getClosestPoint(e),!0===this.isPointCloseToSelected(n,e)&&this.crowd.agentGoto(t,n)})),this.activeAgents=a,this.activeDestination=n.clone()},t.prototype.stopCrowd=function(t){if(!this.crowd)return;let e;t?(e=[],t.forEach((t=>{e.push(this.agentsList[t._guid])}))):e=this.crowd.getAgents(),e.forEach((t=>{this.crowd.agentStop(t)})),this.activeAgents=void 0,this.activeDestination=void 0},t.prototype.isPointCloseToSelected=function(t,e){let s=!0;const n=this.pathfinder.parameters.queryExtent;return Math.abs(t.x-e.x)>n.x&&(s=!1),s&&Math.abs(t.y-e.y)>n.y&&(s=!1),s&&Math.abs(t.z-e.z)>n.z&&(s=!1),s},t.prototype.teleportAgentsTo=function(t,e){if(!this.crowd)return;let s,n;t?(n=[],t.forEach((t=>{n.push(this.agentsList[t._guid])}))):n=this.crowd.getAgents(),n.forEach((t=>{s=this.pathfinder.getClosestPoint(e),!0===this.isPointCloseToSelected(s,e)&&(this.crowd.agentTeleport(t,s),!1===this.crowd.isAgentActive(t)&&this.crowd.getAgentEntity(t).setPosition(s))})),this.activeAgents=void 0,this.activeDestination=void 0},t.prototype.getPath=function(t){if(!this.crowd||!this.activeDestination)return;let e;e=t&&t.length>0?t:this.agents;const s=this.pathfinder,n={};return e.forEach((t=>{const e=s.computePath(s.getClosestPoint(t.getPosition()),this.activeDestination);n[t._guid]=[];const a=n[t._guid];e.forEach((t=>{a.push(t.clone())}))})),n},t.prototype.calculateDebugLines=function(){if(!this.crowd)return;const t=this.pathfinder,e=this.activeAgents;this.debugPath=[],this.debugColors=[],e.forEach((e=>{const s=this.crowd.getAgentEntity(e);if(!s)return!0;const n=t.computePath(t.getClosestPoint(s.getPosition()),this.activeDestination);n.forEach(((t,e)=>{if(0===e)return!0;const s=n[e-1];this.debugPath.push(s),this.debugPath.push(t),this.debugColors.push(this.debugLineColor),this.debugColors.push(this.debugLineColor)}))}))},t.prototype.update=function(){this.activeDestination&&this.debugLines&&(this.calculateDebugLines(),this.app.renderLines(this.debugPath,this.debugColors))}}attachAttributes(t){t.attributes.add("pathfinderEntity",{type:"entity",title:"Pathfinder",description:"Drag and drop the pathfinder entity this crowd should interact with. Updating this requires regenerating the navmesh or reloading your app"}),t.attributes.add("agents",{type:"entity",array:!0,title:"Agents",description:"Assigns agents to this crowd."}),t.attributes.add("maxAgents",{type:"number",default:1,min:1,title:"Max Agents",description:"The maximum number of agents allowed on this crowd."}),t.attributes.add("maxAgentRadius",{type:"number",default:.1,min:0,title:"Max Agent Radius",description:"The maximum radius an agent can have."})}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OrestisCrowd=void 0,e.OrestisCrowd=class{constructor(t,e,s,n){this.vec=new pc.Vec3,this.vec2=new pc.Vec3,this.vec3=new pc.Vec3,this.recastCrowd={},this.entities=new Array,this.agents=new Array,this.agentsActive=new Array,this.agentsTargetPoint=new Array,this.script=t,this.app=t.app,this.pathfinder=e,this.recastCrowd=new this.pathfinder.RECAST.Crowd(s,n,this.pathfinder.navMesh.getNavMesh()),this.agentScriptParameters=[],this.agentCurrentAngleY=[],this.updateRef=this.update.bind(this),this.app.on("update",this.updateRef)}destroy(){this.recastCrowd&&this.recastCrowd.destroy()}addAgent(t,e){var s=new this.pathfinder.RECAST.dtCrowdAgentParams;s.radius=e.radius,s.height=e.height,s.maxAcceleration=e.maxAcceleration,s.maxSpeed=e.maxSpeed,s.collisionQueryRange=e.collisionQueryRange,s.pathOptimizationRange=e.pathOptimizationRange,s.separationWeight=e.separationWeight,s.updateFlags=7,s.obstacleAvoidanceType=0,s.queryFilterType=0,s.userData=0;const n=this.vec3;this.pathfinder.getRandomPointAround(t.getPosition(),.25,n);var a=this.recastCrowd.addAgent(new this.pathfinder.RECAST.Vec3(n.x,n.y,n.z),s);return this.entities.push(t),this.agents.push(a),this.agentScriptParameters[a]=e,this.agentCurrentAngleY[a]=t.getEulerAngles().y,a}getAgentPosition(t,e){const s=this.recastCrowd.getAgentPosition(t),n=-.75*this.pathfinder.parameters.cellHeight;return e?e.set(s.x,s.y+n,s.z):new pc.Vec3(s.x,s.y+n,s.z)}getAgentVelocity(t,e){var s=this.recastCrowd.getAgentVelocity(t);return e?e.set(s.x,s.y,s.z):new pc.Vec3(s.x,s.y,s.z)}getAgentNextTargetPath(t,e){var s=this.recastCrowd.getAgentNextTargetPath(t);return e?e.set(s.x,s.y,s.z):new pc.Vec3(s.x,s.y,s.z)}getAgentState(t){return this.recastCrowd.getAgentState(t)}getAgentEntity(t){return this.entities[t]}getAgentIndex(t){return this.entities.findIndex((e=>e._guid===t._guid))}overOffmeshConnection(t){return this.recastCrowd.overOffmeshConnection(t)}agentGoto(t,e){this.recastCrowd.agentGoto(t,new this.pathfinder.RECAST.Vec3(e.x,e.y,e.z)),this.agentsTargetPoint[t]||(this.agentsTargetPoint[t]=new pc.Vec3),this.agentsTargetPoint[t].copy(e),-1===this.agentsActive.indexOf(t)&&this.agentsActive.push(t)}agentStop(t){const e=this.getAgentEntity(t);if(!e)return;const s=e.getPosition();this.agentTeleport(t,s);const n=this.agentsActive.indexOf(t);n>-1&&this.agentsActive.splice(n,1)}isAgentActive(t){return this.agentsActive.indexOf(t)>-1}agentTeleport(t,e){this.recastCrowd.agentTeleport(t,new this.pathfinder.RECAST.Vec3(e.x,e.y,e.z))}updateAgentParameters(t,e){var s=this.recastCrowd.getAgentParameters(t);void 0!==e.radius&&(s.radius=e.radius),void 0!==e.height&&(s.height=e.height),void 0!==e.maxAcceleration&&(s.maxAcceleration=e.maxAcceleration),void 0!==e.maxSpeed&&(s.maxSpeed=e.maxSpeed),void 0!==e.collisionQueryRange&&(s.collisionQueryRange=e.collisionQueryRange),void 0!==e.pathOptimizationRange&&(s.pathOptimizationRange=e.pathOptimizationRange),void 0!==e.separationWeight&&(s.separationWeight=e.separationWeight),this.agentScriptParameters[t]=e,this.recastCrowd.setAgentParameters(t,s)}removeAgent(t){this.recastCrowd.removeAgent(t);var e=this.agents.indexOf(t);e>-1&&(this.agents.splice(e,1),this.entities.splice(e,1))}getAgents(){return this.agents}update(t){if(this.script.isPaused)return;const e=this.pathfinder,s=null==e?void 0:e.navMesh;if(s){s.update();var n=e.getTimeStep(),a=e.getMaximumSubStepCount();if(n<=.001)this.recastCrowd.update(t);else{var d=Math.floor(t/n);a&&d>a&&(d=a),d<1&&(d=1);var c=t/d;for(let t=0;t<d;t++)this.recastCrowd.update(c)}for(let e=0;e<this.agents.length;e++){if(-1===this.agentsActive.indexOf(e))continue;const s=this.agentScriptParameters[e],n=this.entities[e],a=this.getAgentPosition(this.agents[e],this.vec3);if(s.stopDistance>0){const t=this.agentsTargetPoint[e].distance(a);if(t<=s.stopDistance){this.agentStop(e),n.fire("OrestisPathfinding:agentStopped",t);continue}}if(n.setPosition(a),s.orientAgent){const d=this.getAgentVelocity(e,this.vec2);if(d.length()>.2){const c=this.vec.copy(a).add(d.scale(3)),l=this.vec3.set(c.x,a.y,c.z);n.lookAt(l.x,l.y,l.z);const u=n.getEulerAngles(),p=u.y;this.agentCurrentAngleY[e]=pc.math.lerp(this.agentCurrentAngleY[e],p,s.orientInertia*t),n.setEulerAngles(u.x,this.agentCurrentAngleY[e],u.z)}}}}}setDefaultQueryExtent(t){let e=new this.pathfinder.RECAST.Vec3(t.x,t.y,t.z);this.recastCrowd.setDefaultQueryExtent(e)}getDefaultQueryExtent(t){let e=this.recastCrowd.getDefaultQueryExtent();return t?t.set(e.x,e.y,e.z):new pc.Vec3(e.x,e.y,e.z)}getCorners(t){let e;const s=this.recastCrowd.getPath(t),n=s.getPointCount();var a=[];for(e=0;e<n;e++){let t=s.getPoint(e);a.push(new pc.Vec3(t.x,t.y,t.z))}return a}dispose(){this.recastCrowd.destroy(),this.app.off("update",this.updateRef),this.updateRef=void 0}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=s(6);e.default=class{constructor(){this.createPcScript()}createPcScript(){const t=pc.createScript("orestisPathfinding");this.attachAttributes(t),t.prototype.postInitialize=function(){let t;this.pathfinder=new n.OrestisPathfinder(this),this.vecStart=new pc.Vec3,this.vecEnd=new pc.Vec3,pc.events.attach(this.entity),this.on("attr",(()=>{this.onEventStart||(window.clearTimeout(t),t=window.setTimeout((()=>{this.pathfinder.onAttrUpdate()}),300))})),this.entity.on("OrestisPathfinding:findPath",this.findPath,this),this.entity.on("OrestisPathfinding:getRandomPointAround",this.getRandomPointAround,this),this.on("state",(function(t){this.pathfinder&&(t?this.onEventStart||this.pathfinder.createNavMesh():this.pathfinder.destroy())}),this),this.onEventStart?this.app.on(this.onEventStart,(function(){this.pathfinder.createNavMesh()}),this):this.pathfinder.createNavMesh()},t.prototype.findPath=function(t,e,s){const n=this.pathfinder.getClosestPoint(t,this.vecStart),a=this.pathfinder.getClosestPoint(e,this.vecEnd);s(this.pathfinder.computePath(n,a))},t.prototype.getRandomPointAround=function(t,e,s){s(this.pathfinder.getRandomPointAround(t,e))}}attachAttributes(t){t.attributes.add("cellSize",{type:"number",default:.25,min:0,title:"Cell Size",description:"XZ plane cell size, used to calculate the grid size based on the bounding box of the selected scene. [Limit: >= 0]"}),t.attributes.add("cellHeight",{type:"number",default:.25,min:0,title:"Cell Height",description:"Y-axis cell size, used to calculate the grid size based on the bounding box of the selected scene. [Limit: >= 0]"}),t.attributes.add("walkableHeight",{type:"number",default:1,min:0,title:"Walkable Height",description:"Minimum floor to ceiling height that will still allow the floor area to be considered walkable. [Limit: >=0]"}),t.attributes.add("walkableRadius",{type:"number",default:1,min:0,title:"Walkable Radius",description:"The distance to erode/shrink the walkable area of the heightfield away from obstructions. [Limit: >=0]"}),t.attributes.add("walkableClimb",{type:"number",default:1,min:0,title:"Walkable Climb",description:"Maximum ledge height that is considered to still be traversable. [Limit: >=0]"}),t.attributes.add("regionMinSize",{type:"number",default:8,min:0,title:"Region Min Size",description:"The minimum number of cells allowed to form isolated island areas. [Limit: >=0]"}),t.attributes.add("regionMergeSize",{type:"number",default:20,min:0,title:"Region Merge Size",description:"Any regions with a span count smaller than this value will, if possible, be merged with larger regions. [Limit: >=0]"}),t.attributes.add("edgeMaxLen",{type:"number",default:12,min:0,title:"Edge Max Length",description:"The maximum allowed length for contour edges along the border of the mesh. [Limit: >=0]"}),t.attributes.add("edgeMaxError",{type:"number",default:1.3,min:0,title:"Edge Max Error",description:"The maximum distance a simplfied contour's border edges should deviate the original raw contour. [Limit: >=0]"}),t.attributes.add("vertsPerPoly",{type:"number",default:6,min:3,title:"Max Verts Per Poly",description:"The maximum number of vertices allowed for polygons generated during the contour to polygon conversion process. [Limit: >= 3]"}),t.attributes.add("detailSampleDist",{type:"number",default:6,min:.9,title:"Detail Sample Dist",description:"Sets the sampling distance to use when generating the detail mesh, for height detail only. [Limits: >= 0.9]"}),t.attributes.add("detailSampleMaxError",{type:"number",default:1,min:0,title:"Detail Sample Max Error",description:"The maximum distance the detail mesh surface should deviate from heightfield data, for height detail only. [Limit: >=0]"}),t.attributes.add("tileSize",{type:"number",default:0,min:0,title:"Tile Size",description:"The width/height size of tile's on the xz-plane. If you plan to use obstacles the tileSize should be > 0. [Limit: >= 0]"}),t.attributes.add("borderSize",{type:"number",default:0,min:0,title:"Border Size",description:"The size of the non-navigable border around the heightfield. [Limit: >= 0]"}),t.attributes.add("debugNavMesh",{type:"boolean",default:!1,title:"Debug Nav Mesh",description:"If enabled the generated nav mesh will be rendered."}),t.attributes.add("queryExtent",{type:"vec3",default:[1,1,1],title:"Query Extent",description:"Set the Bounding box extent for doing spatial queries (getClosestPoint, getRandomPointAround etc.)."}),t.attributes.add("excludeTags",{type:"string",default:"navmesh-exclude",title:"Exclude Tags",description:"A comma separated list of entity tags to exclude from the navmesh."}),t.attributes.add("onEventStart",{type:"string",title:"On Event Start",description:"Run the navmesh generator when this app wide event fires, if empty the navmesh will be generated on initialize."}),t.attributes.add("onEventReady",{type:"string",title:"On Event Ready",description:"Fire a custom event when the navmesh generation finished."})}}},function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,e,s,n){return new(s||(s=Promise))((function(a,d){function r(t){try{h(n.next(t))}catch(t){d(t)}}function o(t){try{h(n.throw(t))}catch(t){d(t)}}function h(t){var e;t.done?a(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,o)}h((n=n.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.OrestisPathfinder=void 0;const a=s(7);e.OrestisPathfinder=class{constructor(t,e=Recast){this.RECAST={},this._maximumSubStepCount=10,this._timeStep=1/60,this.parameters=t,this.app=t.app,this.parentEntity=t.entity,"function"==typeof e?e(this.RECAST):this.RECAST=e,this.isSupported()?this.setTimeStep():console.log("Orestis 3D Pathfinding, RecastJS is not available. Please make sure you included the js file.")}onAttrUpdate(){return n(this,void 0,void 0,(function*(){this.createNavMesh()}))}destroy(){this.debugEntity&&(this.debugEntity.model.meshInstances[0].material.destroy(),this.debugEntity.model.meshInstances[0].mesh.destroy(),this.debugEntity.destroy(),this.debugEntity=void 0),this.navMesh&&(this.getCrowdEntities().forEach((t=>{t.script.orestisCrowd.destroyCrowd()})),this.navMesh.destroy(),this.navMesh=void 0)}setTimeStep(t=1/60){this._timeStep=t}getTimeStep(){return this._timeStep}setMaximumSubStepCount(t=10){this._maximumSubStepCount=t}getMaximumSubStepCount(){return this._maximumSubStepCount}createNavMesh(){this.destroy();const t=new this.RECAST.rcConfig,e=this.parameters;t.borderSize=e.borderSize?e.borderSize:0,t.tileSize=e.tileSize?e.tileSize:0,t.cs=e.cellSize,t.ch=e.cellHeight,t.walkableSlopeAngle=e.walkableSlopeAngle?e.walkableSlopeAngle:35,t.walkableHeight=e.walkableHeight,t.walkableClimb=e.walkableClimb,t.walkableRadius=e.walkableRadius,t.maxEdgeLen=e.edgeMaxLen,t.maxSimplificationError=e.edgeMaxError,t.minRegionArea=e.regionMinSize,t.mergeRegionArea=e.regionMergeSize,t.maxVertsPerPoly=e.vertsPerPoly,t.detailSampleDist=e.detailSampleDist,t.detailSampleMaxError=e.detailSampleMaxError;const s=new a.OrestisGeometry(this.parentEntity,e.excludeTags?e.excludeTags.toString().split(","):[]).getGeometry();this.navMesh=new this.RECAST.NavMesh;const n=performance.now();this.navMesh.build(s.positions,s.offset,s.indices,s.indices.length,t);const d=performance.now();console.log(`Orestis 3D Pathfinding, nav mesh generation for ${this.parentEntity.name} entity ${d-n} milliseconds.`),e.debugNavMesh&&this.createDebugNavMesh(),this.bootCrowds(),this.setDefaultQueryExtent(this.parameters.queryExtent)}getCrowdEntities(){const t=this.parentEntity._guid;return this.app.root.find((e=>e.script&&e.script.orestisCrowd&&e.script.orestisCrowd.pathfinderEntity&&e.script.orestisCrowd.pathfinderEntity._guid===t))}bootCrowds(){const t=this.parentEntity._guid;this.getCrowdEntities().forEach((t=>{t.script.orestisCrowd.initializeCrowd(this)})),this.app.root.find((e=>e.script&&e.script.orestisObstacle&&e.script.orestisObstacle.pathfinderEntity&&e.script.orestisObstacle.pathfinderEntity._guid===t)).forEach((t=>{t.script.orestisObstacle.initializeObstacle(this)}))}createDebugNavMesh(t){var e=t?t.indices:null,s=t?t.positions:null;if(!t){e=[],s=[];var n=this.navMesh.getDebugNavMesh();let t=n.getTriangleCount();var a,d;for(a=0;a<3*t;a++)e.push(a);for(a=0;a<t;a++)for(d=0;d<3;d++){let t=n.getTriangle(a).getPoint(d);s.push(t.x,t.y,t.z)}}const c=new pc.Entity,l=new pc.StandardMaterial;l.emissive.set(.8,.8,.8,1),l.cull=pc.CULLFACE_FRONT,l.update();const u=new pc.GraphNode,p=new pc.Mesh(this.app.graphicsDevice);p.setPositions(s),p.setNormals(pc.calculateNormals(s,e)),p.setIndices(e),p.update();const g=new pc.MeshInstance(u,p,l),f=new pc.Model;f.graph=u,f.meshInstances.push(g),c.addComponent("model",{layers:[this.app.scene.layers.getLayerByName("World").id],castShadows:!1,receiveShadows:!1}),c.model.model=f,this.app.root.addChild(c),this.debugEntity=c}isSupported(){return void 0!==this.RECAST}getClosestPoint(t,e){var s=new this.RECAST.Vec3(t.x,t.y,t.z),n=this.navMesh.getClosestPoint(s);return e?e.set(n.x,n.y,n.z):new pc.Vec3(n.x,n.y,n.z)}getRandomPointAround(t,e,s){var n=new this.RECAST.Vec3(t.x,t.y,t.z),a=this.navMesh.getRandomPointAround(n,e);return s?s.set(a.x,a.y,a.z):new pc.Vec3(a.x,a.y,a.z)}moveAlong(t,e,s){var n=new this.RECAST.Vec3(t.x,t.y,t.z),a=new this.RECAST.Vec3(e.x,e.y,e.z),d=this.navMesh.moveAlong(n,a);return s?s.set(d.x,d.y,d.z):new pc.Vec3(d.x,d.y,d.z)}computePath(t,e){var s;let n=new this.RECAST.Vec3(t.x,t.y,t.z),a=new this.RECAST.Vec3(e.x,e.y,e.z),d=this.navMesh.computePath(n,a),c=d.getPointCount();var l=[];for(s=0;s<c;s++){let t=d.getPoint(s);l.push(new pc.Vec3(t.x,t.y,t.z))}return l}setDefaultQueryExtent(t){let e=new this.RECAST.Vec3(t.x,t.y,t.z);this.navMesh.setDefaultQueryExtent(e)}getDefaultQueryExtent(t){let e=this.navMesh.getDefaultQueryExtent();return t?t.set(e.x,e.y,e.z):new pc.Vec3(e.x,e.y,e.z)}buildFromNavmeshData(t){var e=t.length*t.BYTES_PER_ELEMENT,s=this.RECAST._malloc(e),n=new Uint8Array(this.RECAST.HEAPU8.buffer,s,e);n.set(t);let a=new this.RECAST.NavmeshData;a.dataPointer=n.byteOffset,a.size=t.length,this.navMesh=new this.RECAST.NavMesh,this.navMesh.buildFromNavmeshData(a),this.RECAST._free(n.byteOffset)}getNavmeshData(){let t=this.navMesh.getNavmeshData();var e=new Uint8Array(this.RECAST.HEAPU8.buffer,t.dataPointer,t.size),s=new Uint8Array(t.size);return s.set(e),this.navMesh.freeNavmeshData(t),s}addCylinderObstacle(t,e,s){return this.navMesh.addCylinderObstacle(new this.RECAST.Vec3(t.x,t.y,t.z),e,s)}addBoxObstacle(t,e,s){return this.navMesh.addBoxObstacle(new this.RECAST.Vec3(t.x,t.y,t.z),new this.RECAST.Vec3(e.x,e.y,e.z),s)}removeObstacle(t){this.navMesh.removeObstacle(t)}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OrestisGeometry=void 0,e.OrestisGeometry=class{constructor(t,e){this.excludeTags=e,this.setParentEntity(t)}setParentEntity(t){t&&(this.parentEntity=t)}getMeshInstances(t){let e=[];const s=this.excludeTags;let n=t.findComponents("model").concat(t.findComponents("render"));return s.length>0&&(n=n.filter((t=>{const e=t.entity;for(const t of s)if(!0===e.tags.has(t))return!1;return!0}))),n.forEach((t=>{e=e.concat(t.meshInstances)})),e}getMeshGeometry(t){const e=t.node.getWorldTransform(),s=t.mesh.vertexBuffer,n=new pc.VertexIterator(s),a=[],d=new pc.Vec3;for(let t=0;t<s.getNumVertices();t++){const t=n.element[pc.SEMANTIC_POSITION],s=t.array[t.index],c=t.array[t.index+1],l=t.array[t.index+2];d.set(s,c,l),e.transformPoint(d,d),a.push(d.x,d.y,d.z),n.next()}n.end();const c=t.mesh.indexBuffer[pc.RENDERSTYLE_SOLID],l=new Uint16Array(c.lock()),u=[],p=t.mesh.primitive[0].base,g=t.mesh.primitive[0].count;for(let t=0;t<g;t++)u.push(l[t+p]);return{vertices:a,indices:u,numIndices:g,numVertices:a.length/3}}getGeometry(){if(!this.parentEntity)return;const t=this.getMeshInstances(this.parentEntity);if(0===t.length)return;const e=[],s=[];let n=0,a=0;for(let d=0;d<t.length;d++){const c=t[d],l=this.getMeshGeometry(c);let u=0;for(let t=0;t<l.vertices.length;t+=3)s.push(l.vertices[t],l.vertices[t+1],l.vertices[t+2]),u++;for(let t=0;t<l.indices.length;t+=3)e.push(l.indices[t+2]+a,l.indices[t+1]+a,l.indices[t]+a);n+=l.vertices.length/3,a+=u}return{positions:s,indices:e,offset:n}}}}]);var Network=pc.createScript("network");Network.attributes.add("room",{title:"Room",type:"string",default:"/"});var NetworkManager=null;const serverUrl="https://pathfinding-multiplayer.glitch.me";Network.prototype.initialize=function(){NetworkManager=this,this.joined=!1,this.socket=io.connect(serverUrl);var t=this.socket;this.on("destroy",(()=>{t.disconnect(),this.joined=!1})),t.emit("join",this.room,this.getLocalPlayerData(),(t=>{this.joined=!0,this.id=t,this.fire("network:joined")})),t.on("event",((t,e)=>{NetworkManager.fire(t,e)}))},Network.prototype.getLocalPlayerData=function(){var t={};t.id=this.id;var e=window.localStorage.getItem("user-name");t.name=e;var o=Avatar.getSavedAvatar();return t.avatar=o,t},Network.prototype.fireEvent=function(t,e){this.socket.emit("event",t,e)},Network.prototype.getData=function(t,e){this.socket.emit("getdata",t,e)},Network.prototype.setData=function(t,e){this.socket.emit("setdata",t,e)},Network.prototype.getId=function(){return this.id};var ClickCharacterController=pc.createScript("clickCharacterController");ClickCharacterController.attributes.add("cameraEntity",{description:"Camara desde la que lanzamos el raycast.",type:"entity",title:"Camera"}),ClickCharacterController.attributes.add("timetoclick",{description:"Se considera que el usuario hace click si se suelta en menos de este tiempo.",type:"number",title:"Time to Click",default:.1}),ClickCharacterController.attributes.add("crowdEntity",{type:"entity",title:"Crowd"}),ClickCharacterController.attributes.add("debugPath",{type:"boolean",title:"Debug Path",default:!1}),ClickCharacterController.attributes.add("pointer",{description:"Entity que se coloca en la posicion en la que se hace click.",type:"entity",title:"Pointer"}),ClickCharacterController.prototype.initialize=function(){this.pressingTime=100,this.clickPosition={x:0,y:0},this.targetPosition=new pc.Vec3,this.moving=!1,this.animationController=this.entity.script.characterAnimationController,this.setEventListeners("on"),this.on("destroy",function(){this.setEventListeners("off")}.bind(this)),this.entity.parent.addChild(this.pointer),this.setPointer(0,1e3,0);setTimeout((()=>this.crowdEntity.fire("OrestisPathfinding:teleportAgentsTo",[this.entity],this.entity.getPosition())),0)},ClickCharacterController.prototype.setEventListeners=function(t){t||(t="on"),this.app.mouse[t](pc.EVENT_MOUSEDOWN,this.mouseDown,this),this.app.mouse[t](pc.EVENT_MOUSEUP,this.mouseUp,this),this.app.touch&&(this.app.touch[t](pc.EVENT_TOUCHEND,this.touchEnd,this),this.app.touch[t](pc.EVENT_TOUCHSTART,this.touchStart,this)),this.app[t]("UI:ButtonClicked",(function(){this.stop(),this.animationController.stopWalking()}),this)},ClickCharacterController.prototype.update=function(t){this.pressingTime<=this.timetoclick&&(this.pressingTime+=t);var i=this.targetPosition.distance(this.entity.getPosition());this.moving&&i<1.2&&(this.moving=!1,this.animationController.stopWalking())},ClickCharacterController.prototype.mouseDown=function(t){t.button===pc.MOUSEBUTTON_LEFT&&(this.clickPosition.x=t.x,this.clickPosition.y=t.y,this.pressingTime=0)},ClickCharacterController.prototype.touchStart=function(t){if(1==t.touches.length){var i=t.touches[0];this.clickPosition.x=i.x,this.clickPosition.y=i.y,this.pressingTime=0}t.event.preventDefault()},ClickCharacterController.prototype.mouseUp=function(t){t.button===pc.MOUSEBUTTON_LEFT&&this.pressingTime<this.timetoclick&&this.raycast(this.clickPosition),this.pressingTime=100},ClickCharacterController.prototype.touchEnd=function(t){this.pressingTime<this.timetoclick&&this.raycast(this.clickPosition),t.event.preventDefault(),this.pressingTime=100},ClickCharacterController.prototype.raycast=function(t){var i=this.cameraEntity.getPosition(),e=this.cameraEntity.camera.screenToWorld(t.x,t.y,this.cameraEntity.camera.farClip),o=this.app.systems.rigidbody.raycastFirst(i,e);o&&o.entity.tags.has("walkable")&&this.moveTo(o.point)},ClickCharacterController.prototype.moveTo=function(t){this.stop(),this.crowdEntity.fire("OrestisPathfinding:moveAgentsTo",[this.entity],t,this.debugPath),this.targetPosition=t,this.moving=!0,this.animationController.startRunning();var i=this;this.setPointer(t),setTimeout((()=>{i.setPointer(0,1e3,0)}),500)},ClickCharacterController.prototype.stop=function(){this.moving=!1,this.crowdEntity.fire("OrestisPathfinding:stopAgents",[this.entity]),this.setPointer(0,1e3,0)},ClickCharacterController.prototype.setPointer=function(t,i,e){this.pointer&&(void 0===i&&void 0===e&&(i=t.y,e=t.z,t=t.x),this.pointer.setPosition(t,i,e))};var Avatar=pc.createScript("avatar");Avatar.attributes.add("animEntity",{title:"Animation",type:"entity"}),Avatar.attributes.add("defaultModel",{type:"string",title:"Default Model Id"}),Avatar.attributes.add("avatars",{title:"Avatars",type:"json",schema:[{name:"id",type:"string"},{name:"model",type:"entity"}],array:!0});const avatarStorageKey="avatar-id";Avatar.prototype.initialize=function(){this.anim=this.animEntity.anim;var t=window.localStorage.getItem("avatar-id");this.defaultModel=t||this.defaultModel,this.changeAvatar(this.defaultModel)},Avatar.prototype.changeAvatar=function(t){for(let e=0;e<this.avatars.length;e++){var a=this.avatars[e];a.id==t?(a.model.enabled=!0,this.currentAvatarId=t,this.anim.rootBone=a.model):a.model.enabled=!1}},Avatar.saveAvatar=function(t){window.localStorage.setItem("avatar-id",t)},Avatar.getSavedAvatar=function(){return window.localStorage.getItem("avatar-id")};var CharacterAnimationController=pc.createScript("characterAnimationController");CharacterAnimationController.attributes.add("animationEntity",{type:"entity",title:"Animation"}),CharacterAnimationController.prototype.initialize=function(){this.anim=this.animationEntity.anim,this.currentAnimation="idle"},CharacterAnimationController.prototype.startWalking=function(){this.anim.setBoolean("walking",!0),this.anim.setBoolean("running",!1),this.currentAnimation="walking"},CharacterAnimationController.prototype.startRunning=function(){this.anim.setBoolean("walking",!1),this.anim.setBoolean("running",!0),this.currentAnimation="running"},CharacterAnimationController.prototype.stopWalking=function(){this.anim.setBoolean("walking",!1),this.anim.setBoolean("running",!1),this.currentAnimation="idle"};var AvoidCameraClipping=pc.createScript("avoidCameraClipping");AvoidCameraClipping.attributes.add("cameraEntity",{type:"entity",title:"Camera"}),AvoidCameraClipping.attributes.add("centerEntity",{type:"entity",title:"Camera Ray Origin"}),AvoidCameraClipping.attributes.add("rayEndEntity",{type:"entity",title:"Camera Ray End"}),AvoidCameraClipping.attributes.add("obstacleTag",{type:"string",title:"Obstacle Tag",default:"obstacle"}),AvoidCameraClipping.prototype.update=function(t){this.cameraEntity.setPosition(this.raycast())},AvoidCameraClipping.prototype.raycast=function(){var t=this.centerEntity.getPosition(),i=this.rayEndEntity.getPosition(),a=this.app.systems.rigidbody.raycastAll(t,i);for(let t=0;t<a.length;t++){let i=a[t];if(i&&i.entity.tags.has(this.obstacleTag))return i.point}return i};var VirtualJoystick=pc.createScript("virtualJoystick");VirtualJoystick.attributes.add("screenSizeEntity",{type:"entity",title:"Screen Size Indicator"}),VirtualJoystick.attributes.add("buttonEntity",{type:"entity",title:"Button"}),VirtualJoystick.attributes.add("joystick",{type:"entity",title:"Joystick Moving Piece"}),VirtualJoystick.attributes.add("radius",{type:"number",title:"Radius",default:50}),VirtualJoystick.prototype.initialize=function(){var t=this;this.pressing=!1,this.originalPisition={x:this.joystick.getLocalPosition().x,y:this.joystick.getLocalPosition().y},this.pointerPosition={x:0,y:0},this.input={x:0,y:0},this.buttonEntity.button.on("pressedstart",this.pressStarted,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.pressEnded,this),this.app.touch&&this.app.touch.on(pc.EVENT_TOUCHEND,(function(i){i.touches.length<=0&&t.pressEnded()}),this),this.joystickPosVec=new pc.Vec3,this.distanceVec=new pc.Vec3},VirtualJoystick.prototype.pressStarted=function(){this.pressing=!0,this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.mouseMoved,this),this.app.touch&&this.app.touch.on(pc.EVENT_TOUCHMOVE,this.touchMoved,this)},VirtualJoystick.prototype.mouseMoved=function(t){this.pointerPosition.x=t.x,this.pointerPosition.y=t.y},VirtualJoystick.prototype.touchMoved=function(t){this.pointerPosition.x=t.touches[0].x,this.pointerPosition.y=t.touches[0].y},VirtualJoystick.prototype.pressEnded=function(){this.pressing=!1,this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.mouseMoved),this.app.touch&&this.app.touch.off(pc.EVENT_TOUCHMOVE,this.touchMoved)},VirtualJoystick.prototype.update=function(t){if(!this.pressing)return this.joystick.setLocalPosition(this.originalPisition.x,this.originalPisition.y,0),void(this.input={x:0,y:0});var i=this.screenSizeEntity.element,s=i.height,o=i.width,e=this.pointerPosition,n=this.joystickPosVec;n.x=this.remap(e.x,0,window.innerWidth,0,o),n.y=this.remap(e.y,0,window.innerHeight,s,0);var c=this.distanceVec;c.copy(n).sub(this.buttonEntity.getLocalPosition()),c.length()>this.radius&&(n.copy(c),n.normalize().mulScalar(this.radius).add(this.buttonEntity.getLocalPosition())),this.joystick.setLocalPosition(n.x,n.y,0),c.normalize(),this.input.x=c.x,this.input.y=c.y},VirtualJoystick.prototype.remap=function(t,i,s,o,e){return(t-i)/(s-i)*(e-o)+o};var FollowTarget=pc.createScript("followTarget");FollowTarget.attributes.add("targetEntity",{title:"Target",type:"entity"}),FollowTarget.attributes.add("lerp",{type:"number",title:"Lerp"}),FollowTarget.prototype.initialize=function(){this.lerpedPosition=new pc.Vec3(0,0,0)},FollowTarget.prototype.update=function(t){var e=this.entity.getPosition(),i=this.targetEntity.getPosition();this.lerpedPosition.lerp(e,i,this.lerp),this.entity.setPosition(this.lerpedPosition.x,this.lerpedPosition.y,this.lerpedPosition.z)};var ButtonsEventTriggerer=pc.createScript("buttonsEventTriggerer");ButtonsEventTriggerer.prototype.initialize=function(){var t=this.entity.find((function(t){return t.button})),e=this;t.forEach((function(t){t.button.on("click",e.buttonClicked,e),t.button.on("pressedstart",e.buttonPressed,e)}))},ButtonsEventTriggerer.prototype.buttonClicked=function(t){var e=this;setTimeout((()=>e.app.fire("UI:ButtonClicked")),0)},ButtonsEventTriggerer.prototype.buttonPressed=function(t){var e=this;setTimeout((()=>e.app.fire("UI:ButtonPressed")),0)};var MobileDeviceEntity=pc.createScript("mobileDeviceEntity");MobileDeviceEntity.prototype.initialize=function(){this.app.touch?this.entity.enabled=!0:this.entity.enabled=!1};var DirectionalCharacterController=pc.createScript("directionalCharacterController");DirectionalCharacterController.attributes.add("walkingSpeed",{type:"number",default:1.3,title:"Walking Speed"}),DirectionalCharacterController.attributes.add("runningSpeed",{type:"number",default:5,title:"Runnging Speed"}),DirectionalCharacterController.attributes.add("cameraEntity",{type:"entity",title:"Camera"}),DirectionalCharacterController.attributes.add("crowdEntity",{type:"entity",title:"Crowd"}),DirectionalCharacterController.attributes.add("joystickEntity",{type:"entity",title:"Virtual Joystick"}),DirectionalCharacterController.prototype.initialize=function(){this.animationController=this.entity.script.characterAnimationController,this.camForward=new pc.Vec3,this.camRight=new pc.Vec3,this.targetPosition=new pc.Vec3},DirectionalCharacterController.prototype.update=function(t){this.deltaTime=t;var i=this.app,e=this.joystickEntity.script.virtualJoystick,r={x:0,y:0};i.keyboard.isPressed(pc.KEY_A)&&(r.x-=1),i.keyboard.isPressed(pc.KEY_D)&&(r.x+=1),i.keyboard.isPressed(pc.KEY_W)&&(r.y+=1),i.keyboard.isPressed(pc.KEY_S)&&(r.y-=1),this.running=i.keyboard.isPressed(pc.KEY_SHIFT),0!=e.input.x&&(r.x=e.input.x),0!=e.input.y&&(r.y=e.input.y),0==e.input.x&&0==e.input.y||(this.running=!0),0!=r.x||0!=r.y?(this.move(r),this.moving=!0,0==this.running?this.animationController.startWalking():this.animationController.startRunning()):this.moving&&(this.moving=!1,this.animationController.stopWalking())},DirectionalCharacterController.prototype.move=function(t){var i=this.camForward;i.copy(this.cameraEntity.forward);var e=this.camRight;e.copy(this.cameraEntity.right);var r=i.scale(t.y);r.add(e.scale(t.x)),r.y=0;var n=this.running?this.runningSpeed:this.walkingSpeed;r.normalize().scale(this.deltaTime*n);var a=this.targetPosition;a.copy(this.entity.getPosition()),a.add(r);var o=a;this.entity.lookAt(o.x,this.entity.getPosition().y,o.z),this.entity.script.clickCharacterController.stop(),this.crowdEntity.fire("OrestisPathfinding:teleportAgentsTo",[this.entity],a)};var CameraRotationController=pc.createScript("cameraRotationController");CameraRotationController.attributes.add("sensitivity",{type:"number",default:.3}),CameraRotationController.attributes.add("horPivot",{type:"entity"}),CameraRotationController.attributes.add("verPivot",{type:"entity"}),CameraRotationController.attributes.add("maxUp",{type:"number"}),CameraRotationController.attributes.add("maxBottom",{type:"number"}),CameraRotationController.prototype.initialize=function(){this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMove,this),this.app.touch&&(this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this)),this.app.touch&&(this.lastTouchPoint=new pc.Vec2),this.rotX=0,this.rotY=0,this.canRot=!0,this.minTouchIndex=0,this.app.on("UI:ButtonPressed",(function(){this.minTouchIndex++}),this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseEnd,this)},CameraRotationController.prototype.onMove=function(t){this.minTouchIndex>0||this.app.mouse.isPressed(pc.MOUSEBUTTON_LEFT)&&this.rotate(t.dx,t.dy)},CameraRotationController.prototype.onMouseEnd=function(t){t.button==pc.MOUSEBUTTON_LEFT&&(this.minTouchIndex=0)},CameraRotationController.prototype.onTouchStart=function(t){var o=this.minTouchIndex;if(!(o>=t.touches.length)){var i=t.touches[o];this.lastTouchPoint.set(i.x,i.y),t.touches.length>o+1&&(this.canRot=!1)}},CameraRotationController.prototype.onTouchEnd=function(t){this.minTouchIndex>t.touches.length&&(this.minTouchIndex=t.touches.length),0==t.touches.length&&(this.minTouchIndex=0),t.touches.length==this.minTouchIndex&&(this.canRot=!0)},CameraRotationController.prototype.onTouchMove=function(t){var o=this.minTouchIndex;if(!(o>=t.touches.length)){var i=t.touches[o],n=i.x-this.lastTouchPoint.x,e=i.y-this.lastTouchPoint.y;this.rotate(n,e),this.lastTouchPoint.set(i.x,i.y)}},CameraRotationController.rotQuat=new pc.Quat,CameraRotationController.prototype.rotate=function(t,o){if(0!=this.canRot){var i=CameraRotationController.rotQuat;this.rotY+=-t*this.sensitivity,i.setFromEulerAngles(0,this.rotY,0),this.horPivot.setLocalRotation(i),this.rotX+=-o*this.sensitivity,this.rotX=pc.math.clamp(this.rotX,-this.maxUp,this.maxBottom),i.setFromEulerAngles(this.rotX,0,0),this.verPivot.setLocalRotation(i)}};var CameraZoom=pc.createScript("cameraZoomController");CameraZoom.attributes.add("camera",{type:"entity",title:"Camera"}),CameraZoom.attributes.add("min",{type:"number",title:"Min distance",default:-2}),CameraZoom.attributes.add("max",{type:"number",title:"Max distance",default:0}),CameraZoom.attributes.add("sensitivity",{type:"number",title:"Sensistibity",default:.5}),CameraZoom.prototype.initialize=function(){this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onWheelInput,this),this.app.touch&&(this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this)),this.originalPosition=this.camera.getLocalPosition().clone(),this.currentZoomAmount=this.originalPosition.length(),this.lastTouchDistance=0,this.zoomDirection=new pc.Vec3,this.zoom(0),this.buttonPressed=!1,this.app.on("UI:ButtonPressed",(()=>this.buttonPressed=!0),this),this.app.mouse.on(pc.EVENT_MOUSEUP,(()=>this.buttonPressed=!1),this),this.app.touch&&this.app.touch.on(pc.EVENT_TOUCHEND,(function(t){0==t.touches.length&&(this.buttonPressed=!1)}),this)},CameraZoom.prototype.onWheelInput=function(t){this.zoom(t.wheelDelta)},CameraZoom.prototype.onTouchStart=function(t){t.touches.length<2||(this.prevPitchDistance=this.getPinchDistance(t.touches[0],t.touches[1]))},CameraZoom.prototype.onTouchMove=function(t){if(!(t.touches.length<2)){var o=this.getPinchDistance(t.touches[0],t.touches[1]);if(this.prevPitchDistance){var i=this.prevPitchDistance-o;this.zoom(.01*i)}this.prevPitchDistance=o}},CameraZoom.prototype.getPinchDistance=function(t,o){var i=t.x-o.x,e=t.y-o.y;return Math.sqrt(i*i+e*e)},CameraZoom.prototype.zoom=function(t){if(!this.buttonPressed){this.currentZoomAmount+=t*this.sensitivity,this.currentZoomAmount=pc.math.clamp(this.currentZoomAmount,this.min,this.max);var o=this.zoomDirection;o.copy(this.originalPosition),o.normalize();var i=o.scale(this.currentZoomAmount);this.camera.setLocalPosition(i)}};var VRManagerScript=pc.createScript("VRManager");VRManagerScript.attributes.add("cameraTemplate",{type:"asset",title:"Camera Template"}),VRManagerScript.attributes.add("controllerTemplate",{type:"asset",title:"Controller Template"}),VRManagerScript.prototype.initialize=function(){VRManager.cameraTemplate=this.cameraTemplate,VRManager.controllerTemplate=this.controllerTemplate,VRManager.initialize()},VRManager={},VRManager.initialize=function(){VRManager.initialized||(VRManager.initialized=!0,this.vrCameraEntity=this.cameraTemplate.resource.instantiate(),pc.app.root.addChild(this.vrCameraEntity),this.vrCameraEntity.enabled=!0,pc.app.xr.on("start",(function(){this.prevCameraPriority=this.vrCamera.priority,this.vrCamera.priority=1e4;var e=pc.app.root.findComponents("screen");this.deletedScreens=[],e.forEach(function(e){1==e.screenSpace&&(e.entity.enabled=!1,this.deletedScreens.push(e))}.bind(this))}),VRManager),pc.app.xr.on("end",(function(){this.vrCamera.priority=this.prevCameraPriority,this.deletedScreens&&(this.deletedScreens.forEach(function(e){e.entity.enabled=!0}.bind(this)),this.deletedScreens=[])}),VRManager),pc.app.xr.input.on("add",(function(e){if(e.handedness!=pc.XRHAND_NONE){var t=this.controllerTemplate.resource.instantiate();pc.app.root.addChild(t),t.enabled=!0,setTimeout((function(){t.fire("vr:setinputsource",e)}),0)}}),VRManager))},VRManager.startVR=function(){if(!pc.app.xr.active&&this.checkVrAvailability()&&(this.vrCamera=this.vrCameraEntity.findComponent("camera"),this.vrCamera)){var e=function(){this.vrCamera.startXr(pc.XRTYPE_VR,pc.XRSPACE_LOCALFLOOR)}.bind(this);window.DeviceOrientationEvent&&window.DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(function(t){"granted"==t?window.addEventListener("deviceorientation",function(t){e()}.bind(this)):console.warn("Permisos de VR rechazados.")}.bind(this)).catch(console.error):e()}},VRManager.endVR=function(){this.vrCamera&&pc.app.xr.active&&this.vrCamera.endXr()},VRManager.checkVrAvailability=function(){var e=pc.app.xr.supported&&pc.app.xr.isAvailable(pc.XRTYPE_VR);return e=e&&"https:"==window.location.protocol};var VRStartButton=pc.createScript("VRStartButton");VRStartButton.prototype.postInitialize=function(){this.button=this.entity.element,this.button&&this.button.on("click",(function(){VRManager?VRManager.startVR():console.error("VRStartButton ["+this.entity.name+"]: No se ha encontrado una instancia del VRManager.")}),this)};var VREndButton=pc.createScript("VREndButton");VREndButton.prototype.postInitialize=function(){this.button=this.entity.element,this.button&&this.button.on("click",(function(){VRManager?VRManager.endVR():console.error("VRStartButton ["+this.entity.name+"]: No se ha encontrado una instancia del VRManager.")}),this)};var VRController=pc.createScript("VRController");VRController.prototype.initialize=function(){this.entity.on("vr:setinputsource",this.setInputSource,this)},VRController.prototype.setInputSource=function(t){this.inputSource&&this.setEventListeners(!1),this.inputSource=t,this.setEventListeners("on"),this.on("destroy",(function(){this.setEventListeners("off")}),this),t.once("remove",(function(){this.entity.destroy()}),this)},VRController.prototype.setEventListeners=function(t){this.inputSource&&(this.inputSource[t]("selectstart",this.onSelectStart,this),this.inputSource[t]("selectend",this.onSelectEnd,this))},VRController.prototype.onSelectStart=function(t){this.inputSource.elementEntity||this.entity.fire("vr:input:selectstart",t)},VRController.prototype.onSelectEnd=function(t){this.entity.fire("vr:input:selectend",t)},VRController.prototype.update=function(t){this.inputSource&&(this.entity.setPosition(this.inputSource.getPosition()),this.entity.setRotation(this.inputSource.getRotation()),this.entity.setEulerAngles(this.entity.getEulerAngles().x-60,this.entity.getEulerAngles().y,this.entity.getEulerAngles().z))};var VRAvailabilityUi=pc.createScript("VRAvailabilityUI");VRAvailabilityUi.attributes.add("avialableUI",{type:"entity",title:"Avialable UI"}),VRAvailabilityUi.attributes.add("unavialableUI",{type:"entity",title:"Unavialable UI"}),VRAvailabilityUi.prototype.postInitialize=function(){this.app.xr.on("available:"+pc.XRTYPE_VR,this.onVRAvailabilityChanged,this),this.on("destroy",(function(){this.onVRAvailabilityChanged(),this.app.xr.off("available:"+pc.XRTYPE_VR,this.onVRAvailabilityChanged)}),this),this.onVRAvailabilityChanged()},VRAvailabilityUi.prototype.onVRAvailabilityChanged=function(i){var a=VRManager;a&&(i=a.checkVrAvailability()),this.setAviabilityUI(i)},VRAvailabilityUi.prototype.setAviabilityUI=function(i){VRManager||(i=!1),this.avialableUI&&(this.avialableUI.enabled=i),this.unavialableUI&&(this.unavialableUI.enabled=!i)};var TestRaycastTarget=pc.createScript("testRaycastTarget");TestRaycastTarget.prototype.initialize=function(){this.entity.on("input:pointerenter",(function(){console.log("Pointer ENTER.")}),this),this.entity.on("input:pointerexit",(function(){console.log("Pointer EXIT.")}),this),this.entity.on("input:pointerdown",(function(){console.log("Pointer DOWN.")}),this),this.entity.on("input:pointerup",(function(){console.log("Pointer UP.")}),this),this.entity.on("input:click",(function(){console.log("Pointer CLICK.")}),this)};var VREntity=pc.createScript("VREntity");VREntity.attributes.add("activeInVR",{type:"boolean",title:"Active in VR",default:!0}),VREntity.prototype.initialize=function(){this.setEventListeners("on"),this.on("destroy",(function(){this.setEventListeners("off")}),this),this.app.xr.active?this.entity.enabled=this.activeInVR:this.entity.enabled=!this.activeInVR},VREntity.prototype.setEventListeners=function(t){this.app.xr[t]("start",this.onVrStarted,this),this.app.xr[t]("end",this.onVrEnded,this)},VREntity.prototype.onVrStarted=function(){this.entity.enabled=this.activeInVR},VREntity.prototype.onVrEnded=function(){this.entity.enabled=!this.activeInVR};var VRRaycaster=pc.createScript("VRRaycaster");VRRaycaster.attributes.add("distance",{type:"number",title:"Ray Distance"}),VRRaycaster.attributes.add("pointer",{type:"entity",title:"Ray Pointer"}),VRRaycaster.attributes.add("line",{type:"entity",title:"Ray Line"}),VRRaycaster.prototype.initialize=function(){this.entity.on("vr:input:selectstart",this.onPointerDown,this),this.entity.on("vr:input:selectend",this.onPointerUp,this),this.on("destroy",(function(){this.entity.off("vr:input:selectstart",this.onPointerDown,this),this.entity.off("vr:input:selectend",this.onPointerUp,this)}),this)},VRRaycaster.prototype.update=function(t){this.raycast()},VRRaycaster.prototype.raycast=function(){this.vector||(this.vector=new pc.Vec3);var t=this.entity.getPosition(),i=this.vector;i.copy(this.entity.forward).mulScalar(this.distance).add(t);var e=this.app.systems.rigidbody.raycastFirst(t,i);if(e){e.entity!=this.hoveringEntity&&this.changeHoveringEntity(e.entity),this.pointer.setPosition(e.point),this.vector.copy(e.point),this.vector.add(e.normal),this.pointer.lookAt(this.vector);var n=this.vector.copy(e.point).sub(this.entity.getPosition()).length();this.line.setLocalScale(1,1,n)}else this.hoveringEntity&&this.changeHoveringEntity(null),this.pointer.setPosition(0,1e4,0),this.line.setLocalScale(1,1,0)},VRRaycaster.prototype.changeHoveringEntity=function(t){this.hoveringEntity&&this.hoveringEntity.fire("input:pointerexit"),this.hoveringEntity=t,this.hoveringEntity&&this.hoveringEntity.fire("input:pointerenter")},VRRaycaster.prototype.onPointerDown=function(){this.hoveringEntity?(this.hoveringEntity.fire("input:pointerdown"),this.selectedEntity=this.hoveringEntity):this.selectedEntity=null},VRRaycaster.prototype.onPointerUp=function(){this.selectedEntity&&(this.selectedEntity==this.hoveringEntity&&this.selectedEntity.fire("input:click"),this.selectedEntity.fire("input:pointerup")),this.selectedEntity=null};var VRScripts=pc.createScript("VRScripts");VRScripts.attributes.add("vrscripts",{type:"string",title:"VR Scripts",array:!0}),VRScripts.attributes.add("nonvrscripts",{type:"string",title:"Non-VR Scripts",array:!0}),VRScripts.prototype.initialize=function(){this.setEventListeners("on"),this.on("destroy",(function(){this.setEventListeners("off")}),this),this.setVR(this.app.xr.enabled)},VRScripts.prototype.setEventListeners=function(t){this.app.xr[t]("start",this.onVrStarted,this),this.app.xr[t]("end",this.onVrEnded,this)},VRScripts.prototype.onVrStarted=function(){this.setVR(!0)},VRScripts.prototype.onVrEnded=function(){this.setVR(!1)},VRScripts.prototype.setVR=function(t){var i=this.entity.script;i&&(this.vrscripts.forEach(function(s){this.setScript(i[s],t)}.bind(this)),this.nonvrscripts.forEach(function(s){this.setScript(i[s],!t)}.bind(this)))},VRScripts.prototype.setScript=function(t,i){t&&(t.enabled=i)};var VRTeleporter=pc.createScript("VRTeleporter");VRTeleporter.prototype.initialize=function(){this.entity.on("vr:input:selectstart",this.onPointerDown,this)},VRTeleporter.prototype.onPointerDown=function(){var t=this.entity.script.VRRaycaster;if(t){var e=t.hoveringEntity;if(e&&e.tags.has("walkable")){var i=t.pointer.getPosition();Game.instance.crowdEntity.fire("OrestisPathfinding:teleportAgentsTo",[Game.instance.localPlayer],i)}}};var SyncEntityRotation=pc.createScript("syncEntityRotation");SyncEntityRotation.attributes.add("syncingEntity",{type:"entity",title:"Syncing Entity"}),SyncEntityRotation.attributes.add("yconstrain",{type:"boolean",title:"Y Constrain"}),SyncEntityRotation.prototype.initialize=function(){this.targetPosition=new pc.Vec3},SyncEntityRotation.prototype.update=function(t){var i=this.targetPosition;i.copy(this.syncingEntity.getPosition()).add(this.entity.forward),this.yconstrain&&(i.y=this.syncingEntity.getPosition().y),this.syncingEntity.lookAt(i)};var Game=pc.createScript("Game");Game.attributes.add("localPlayer",{type:"entity",title:"Local Player"}),Game.attributes.add("crowdEntity",{type:"entity",title:"Crowd"}),Game.instance=null,Game.prototype.initialize=function(){null==Game.instance&&(Game.instance=this,this.entity.on("destroy",(function(){Game.instance=null}),this))};var VoiceChat=pc.createScript("VoiceChat");VoiceChat.prototype.postInitialize=function(){NetworkManager.on("network:joined",this.voiceChat,this),this.muteSelf="true"==window.localStorage.getItem("mute"),this.muteEveryone=!1},VoiceChat.prototype.voiceChat=function(){const t=NetworkManager.socket;var e=this;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(o){var i=new MediaRecorder(o);i.start(),setTimeout((function(){i.stop()}),500);var a=[];i.ondataavailable=t=>{a.push(t.data)},i.addEventListener("stop",(function(){if(0==e.muteSelf&&0==e.muteEveryone){var o=new Blob(a),n=new FileReader;n.readAsDataURL(o),n.onload=function(e){var o=e.target.result,i={};i.id=NetworkManager.id,i.voice=o,t.emit("voice",i)}}a=[],i.start(),setTimeout((function(){i.stop()}),500)}))}.bind(this)),t.on("voice",this.onDataReceived.bind(this))},VoiceChat.prototype.onDataReceived=function(t){if(!this.muteEveryone){var e=t.voice.split(";")[1].split(",")[1],o=this.base64ToArrayBuffer(e),i=this.getAudioContext(),a=i.createBufferSource();i.decodeAudioData(o,function(t){a.buffer=t,a.connect(i.destination),a.start(0)}.bind(this))}},VoiceChat.prototype.getAudioContext=function(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},VoiceChat.prototype.base64ToArrayBuffer=function(t){for(var e=window.atob(t),o=e.length,i=new Uint8Array(o),a=0;a<o;a++)i[a]=e.charCodeAt(a);return i.buffer},VoiceChat.prototype.setMuteSelf=function(t){this.muteSelf=t,window.localStorage.setItem("mute",this.muteSelf)},VoiceChat.prototype.toggleMuteSelf=function(){this.setMuteSelf(!this.muteSelf)};function ScreenFader(t={r:0,g:0,b:0}){var e=pc.app,i=document.createElement("div");i.id="screen-fader",i.style.cssText+="width: 100vw; height:100vh; position:absolute;",i.style.cssText+="z-index: 100;",i.style.cssText+="background-color: rgb("+t.r+","+t.g+","+t.b+");",document.body.appendChild(i),i.style.opacity=0,i.style.display="none",this.fade=function(t,a=1,n){i.style.display="initial";var s=t?0:1,l=t?1:0,o=pc.math.lerp(s*a,l*a,i.style.opacity),fadingLoop=function(y){var c=o/a,d=pc.math.lerp(s,l,c);i.style.opacity=d,(o+=y)>=a&&(e.off("update",fadingLoop),i.style.opacity=l,i.style.display=t?"initial":"none",n&&setTimeout(n,100))};e.on("update",fadingLoop)},this.fadeInmidiatly=function(t){var e=t?1:0;i.style.opacity=e,i.style.display=t?"initial":"none"}}var SceneManager={currentScene:"initial",loadScene:function(e){var n=pc.app,a=n.scenes.find(e);if(a){n.fire("scene:unloading"),n.root.findByName("Root").destroy();var c=0,onSceneLoaded=function(a){a?console.log("Error al cargar la escena ["+e+"]: "+a):c++,c>=3&&(SceneManager.currentScene=e,n.fire("scene:loaded"))};n.scenes.loadSceneData(a,onSceneLoaded),n.scenes.loadSceneHierarchy(a,onSceneLoaded),n.scenes.loadSceneSettings(a,onSceneLoaded)}else console.error("Error al cargar la escena: ["+e+"] no existe.")},fadeToScene:function(e,n=.5){SceneManager.checkForScene(e)?(SceneManager.screenFader||(SceneManager.screenFader=new ScreenFader({r:255,g:255,b:255})),SceneManager.screenFader.fade(!0,n,(function(){pc.app.once("scene:loaded",(function(){SceneManager.screenFader.fade(!1,n)})),SceneManager.loadScene(e)}))):console.error("Error al cargar la escena: ["+e+"] no existe.")},checkForScene:function(e){return!!pc.app.scenes.find(e)}};var DontDestroyOnload=pc.createScript("DontDestroyOnload");DontDestroyOnload.prototype.initialize=function(){this.app.on("scene:unloading",(function(){this.entity.reparent(null)}),this),this.app.on("scene:loaded",(function(){var t=this.app.root.findByName("Root");this.entity.reparent(t)}),this)};var LoadOnstart=pc.createScript("LoadOnStart");LoadOnstart.attributes.add("scene",{type:"string",title:"Scene to Load",default:"target-scene"}),LoadOnstart.attributes.add("delay",{type:"number",title:"Delay",default:0}),LoadOnstart.attributes.add("fade",{type:"boolean",title:"Fade",default:!0}),LoadOnstart.prototype.initialize=function(){var e=this;setTimeout((function(){e.fade?SceneManager.fadeToScene(e.scene):SceneManager.loadScene(e.scene)}),1e3*e.delay)};var LoadSceneOnClick=pc.createScript("loadSceneOnClick");LoadSceneOnClick.attributes.add("scene",{type:"string",title:"Target Scene"}),LoadSceneOnClick.attributes.add("fade",{type:"boolean",title:"Fade",default:!0}),LoadSceneOnClick.prototype.postInitialize=function(){var e=this.entity.element;if(e){var t=this;e.on("click",(function(){t.fade?SceneManager.fadeToScene(t.scene):SceneManager.loadScene(t.scene)}))}};var LoadSceneOnClickHtml=pc.createScript("loadSceneOnClickHtml");LoadSceneOnClickHtml.attributes.add("buttonId",{type:"string",title:"Button Id"}),LoadSceneOnClickHtml.attributes.add("scene",{type:"string",title:"Target Scene"}),LoadSceneOnClickHtml.attributes.add("fade",{type:"boolean",title:"Fade",default:!0}),LoadSceneOnClickHtml.prototype.postInitialize=function(){var e=document.getElementById(this.buttonId);if(e){var t=this;e.addEventListener("click",(function(){t.fade?SceneManager.fadeToScene(t.scene):SceneManager.loadScene(t.scene)}))}};var HtmlAdder=pc.createScript("htmlAdder");HtmlAdder.attributes.add("htmlFiles",{type:"asset",title:"HTML",array:!0}),HtmlAdder.attributes.add("cssFiles",{type:"asset",title:"CSS",array:!0}),HtmlAdder.prototype.initialize=function(){this.addHtml(),this.addCss(),this.app.on("scene:unloading",this.removeUi)},HtmlAdder.prototype.addHtml=function(){var e=document.createElement("div");e.id="game-ui",e.style="width: 100vw; height:100vh; position:absolute;";for(let t=0;t<this.htmlFiles.length;t++){let d=this.htmlFiles[t];e.innerHTML+=d.resource+"\n"}document.body.appendChild(e)},HtmlAdder.prototype.addCss=function(){var e=document.createElement("style");e.id="game-ui-style";for(let t=0;t<this.cssFiles.length;t++){let d=this.cssFiles[t];e.innerHTML+=d.resource+"\n"}document.head.appendChild(e)},HtmlAdder.prototype.removeUi=function(){var e=document.getElementById("game-ui");e&&document.body.removeChild(e);var t=document.getElementById("game-ui-style");t&&document.head.removeChild(t)};var SaveNameOnClick=pc.createScript("saveNameOnClick");SaveNameOnClick.attributes.add("buttonId",{type:"string",title:"Button Id"}),SaveNameOnClick.attributes.add("inputFieldId",{type:"string",title:"Input Field Id"}),SaveNameOnClick.attributes.add("storageKey",{type:"string",title:"Save in storage as"}),SaveNameOnClick.prototype.initialize=function(){var t=document.getElementById(this.buttonId);if(t){var e=document.getElementById(this.inputFieldId),a=this.storageKey;t.addEventListener("click",(function(){e&&window.localStorage.setItem(a,e.value)}));var i=window.localStorage.getItem(a);e.value=i}};var LookAttarget=pc.createScript("lookAttarget");LookAttarget.attributes.add("target",{type:"entity",title:"Target"}),LookAttarget.prototype.initialize=function(){},LookAttarget.prototype.postUpdate=function(t){this.entity.lookAt(this.target.getPosition())};var Vrplayer=pc.createScript("vrplayer");Vrplayer.attributes.add("camera",{type:"entity",title:"Camera"}),Vrplayer.prototype.initialize=function(){this.findPlayer(),this.setListeners("on"),this.on("destroy",(function(){console.log("Destroying VR Player"),this.setListeners("off")}),this),this.targetPosition=new pc.Vec3},Vrplayer.prototype.setListeners=function(t){this.app[t]("scene:loaded",this.findPlayer,this)},Vrplayer.prototype.findPlayer=function(){this.player=this.app.root.findByTag("player")[0]},Vrplayer.prototype.update=function(t){if(pc.app.xr.active&&this.player){this.entity.setPosition(this.player.getPosition());var e=this.targetPosition;e.copy(this.player.getPosition()).add(this.camera.forward),e.y=this.player.getPosition().y,this.player.lookAt(e)}};var ChangeAvatarButton=pc.createScript("changeAvatarButton");ChangeAvatarButton.attributes.add("avatarEntity",{type:"entity",title:"Avatar"}),ChangeAvatarButton.attributes.add("avatarId",{type:"string",title:"Avatar Id"}),ChangeAvatarButton.prototype.initialize=function(){this.entity.element.on("click",(function(){this.avatarEntity.script.avatar.changeAvatar(this.avatarId),this.avatarEntity.script.avatar.saveAvatar(this.avatarId)}),this)};pc.extend(pc,function(){var TweenManager=function(t){this._app=t,this._tweens=[],this._add=[]};TweenManager.prototype={add:function(t){return this._add.push(t),t},update:function(t){for(var i=0,e=this._tweens.length;i<e;)this._tweens[i].update(t)?i++:(this._tweens.splice(i,1),e--);if(this._add.length){for(let t=0;t<this._add.length;t++)this._tweens.indexOf(this._add[t])>-1||this._tweens.push(this._add[t]);this._add.length=0}}};var Tween=function(t,i,e){pc.events.attach(this),this.manager=i,e&&(this.entity=null),this.time=0,this.complete=!1,this.playing=!1,this.stopped=!0,this.pending=!1,this.target=t,this.duration=0,this._currentDelay=0,this.timeScale=1,this._reverse=!1,this._delay=0,this._yoyo=!1,this._count=0,this._numRepeats=0,this._repeatDelay=0,this._from=!1,this._slerp=!1,this._fromQuat=new pc.Quat,this._toQuat=new pc.Quat,this._quat=new pc.Quat,this.easing=pc.Linear,this._sv={},this._ev={}},_parseProperties=function(t){var i;return t instanceof pc.Vec2?i={x:t.x,y:t.y}:t instanceof pc.Vec3?i={x:t.x,y:t.y,z:t.z}:t instanceof pc.Vec4||t instanceof pc.Quat?i={x:t.x,y:t.y,z:t.z,w:t.w}:t instanceof pc.Color?(i={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(i.a=t.a)):i=t,i};Tween.prototype={to:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this},from:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._from=!0,this},rotate:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._slerp=!0,this},start:function(){var t,i,e,s;if(this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this.pending=this._delay>0,this._reverse&&!this.pending?this.time=this.duration:this.time=0,this._from){for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this._properties[t],this._ev[t]=this.target[t]);this._slerp&&(this._toQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,this._fromQuat.setFromEulerAngles(i,e,s))}else{for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this.target[t],this._ev[t]=this._properties[t]);this._slerp&&(i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,void 0!==this._properties.w?(this._fromQuat.copy(this.target),this._toQuat.set(i,e,s,this._properties.w)):(this._fromQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),this._toQuat.setFromEulerAngles(i,e,s)))}return this._currentDelay=this._delay,this.manager.add(this),this},pause:function(){this.playing=!1},resume:function(){this.playing=!0},stop:function(){this.playing=!1,this.stopped=!0},delay:function(t){return this._delay=t,this.pending=!0,this},repeat:function(t,i){return this._count=0,this._numRepeats=t,this._repeatDelay=i||0,this},loop:function(t){return t?(this._count=0,this._numRepeats=1/0):this._numRepeats=0,this},yoyo:function(t){return this._yoyo=t,this},reverse:function(){return this._reverse=!this._reverse,this},chain:function(){for(var t=arguments.length;t--;)t>0?arguments[t-1]._chained=arguments[t]:this._chained=arguments[t];return this},update:function(t){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this.time+=t*this.timeScale:this.time-=t*this.timeScale,this.pending){if(!(this.time>this._currentDelay))return!0;this._reverse?this.time=this.duration-(this.time-this._currentDelay):this.time-=this._currentDelay,this.pending=!1}var i=0;(!this._reverse&&this.time>this.duration||this._reverse&&this.time<0)&&(this._count++,this.complete=!0,this.playing=!1,this._reverse?(i=this.duration-this.time,this.time=0):(i=this.time-this.duration,this.time=this.duration));var e,s,n=0===this.duration?1:this.time/this.duration,r=this.easing(n);for(var h in this._properties)this._properties.hasOwnProperty(h)&&(e=this._sv[h],s=this._ev[h],this.target[h]=e+(s-e)*r);if(this._slerp&&this._quat.slerp(this._fromQuat,this._toQuat,r),this.entity&&(this.entity._dirtifyLocal(),this.element&&this.entity.element&&(this.entity.element[this.element]=this.target),this._slerp&&this.entity.setLocalRotation(this._quat)),this.fire("update",t),this.complete){var a=this._repeat(i);return a?this.fire("loop"):(this.fire("complete",i),this.entity&&this.entity.off("destroy",this.stop,this),this._chained&&this._chained.start()),a}return!0},_repeat:function(t){if(this._count<this._numRepeats){if(this._reverse?this.time=this.duration-t:this.time=t,this.complete=!1,this.playing=!0,this._currentDelay=this._repeatDelay,this.pending=!0,this._yoyo){for(var i in this._properties){var e=this._sv[i];this._sv[i]=this._ev[i],this._ev[i]=e}this._slerp&&(this._quat.copy(this._fromQuat),this._fromQuat.copy(this._toQuat),this._toQuat.copy(this._quat))}return!0}return!1}};var BounceOut=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},BounceIn=function(t){return 1-BounceOut(1-t)};return{TweenManager:TweenManager,Tween:Tween,Linear:function(t){return t},QuadraticIn:function(t){return t*t},QuadraticOut:function(t){return t*(2-t)},QuadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn:function(t){return t*t*t},CubicOut:function(t){return--t*t*t+1},CubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},QuarticIn:function(t){return t*t*t*t},QuarticOut:function(t){return 1- --t*t*t*t},QuarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},QuinticIn:function(t){return t*t*t*t*t},QuinticOut:function(t){return--t*t*t*t*t+1},QuinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},SineIn:function(t){return 0===t?0:1===t?1:1-Math.cos(t*Math.PI/2)},SineOut:function(t){return 0===t?0:1===t?1:Math.sin(t*Math.PI/2)},SineInOut:function(t){return 0===t?0:1===t?1:.5*(1-Math.cos(Math.PI*t))},ExponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},ExponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},ExponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},CircularIn:function(t){return 1-Math.sqrt(1-t*t)},CircularOut:function(t){return Math.sqrt(1- --t*t)},CircularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},BackIn:function(t){var i=1.70158;return t*t*((i+1)*t-i)},BackOut:function(t){var i=1.70158;return--t*t*((i+1)*t+i)+1},BackInOut:function(t){var i=2.5949095;return(t*=2)<1?t*t*((i+1)*t-i)*.5:.5*((t-=2)*t*((i+1)*t+i)+2)},BounceIn:BounceIn,BounceOut:BounceOut,BounceInOut:function(t){return t<.5?.5*BounceIn(2*t):.5*BounceOut(2*t-1)+.5},ElasticIn:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),-e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/.4))},ElasticOut:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),e*Math.pow(2,-10*t)*Math.sin((t-i)*(2*Math.PI)/.4)+1)},ElasticInOut:function(t){var i,e=.1,s=.4;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=s*Math.asin(1/e)/(2*Math.PI),(t*=2)<1?e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*-.5:e*Math.pow(2,-10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*.5+1)}}}()),function(){pc.AppBase.prototype.addTweenManager=function(){this._tweenManager=new pc.TweenManager(this),this.on("update",(function(t){this._tweenManager.update(t)}))},pc.AppBase.prototype.tween=function(t){return new pc.Tween(t,this._tweenManager)},pc.Entity.prototype.tween=function(t,i){var e=this._app.tween(t);return e.entity=this,this.once("destroy",e.stop,e),i&&i.element&&(e.element=i.element),e};var t=pc.AppBase.getApplication();t&&t.addTweenManager()}();function HueSaturationEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uHue;","uniform float uSaturation;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","","    float angle = uHue * 3.14159265;","    float s = sin(angle), c = cos(angle);","    vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","    float len = length(gl_FragColor.rgb);","    gl_FragColor.rgb = vec3(","        dot(gl_FragColor.rgb, weights.xyz),","        dot(gl_FragColor.rgb, weights.zxy),","        dot(gl_FragColor.rgb, weights.yzx)","    );","","    float average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;","    if (uSaturation > 0.0) {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - uSaturation));","    } else {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (-uSaturation);","    }","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"HueSaturationShader",{aPosition:pc.SEMANTIC_POSITION}),this.hue=0,this.saturation=0}HueSaturationEffect.prototype=Object.create(pc.PostEffect.prototype),HueSaturationEffect.prototype.constructor=HueSaturationEffect,Object.assign(HueSaturationEffect.prototype,{render:function(t,e,r){var a=this.device.scope;a.resolve("uHue").setValue(this.hue),a.resolve("uSaturation").setValue(this.saturation),a.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,r)}});var HueSaturation=pc.createScript("hueSaturation");HueSaturation.attributes.add("hue",{type:"number",default:0,min:-1,max:1,title:"Hue"}),HueSaturation.attributes.add("saturation",{type:"number",default:0,min:-1,max:1,title:"Saturation"}),HueSaturation.prototype.initialize=function(){this.effect=new HueSaturationEffect(this.app.graphicsDevice),this.effect.hue=this.hue,this.effect.saturation=this.saturation,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function BrightnessContrastEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uBrightness;","uniform float uContrast;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","    gl_FragColor.rgb += uBrightness;","","    if (uContrast > 0.0) {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - uContrast) + 0.5;","    } else {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + uContrast) + 0.5;","    }","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"BrightnessContrastShader",{aPosition:pc.SEMANTIC_POSITION}),this.brightness=0,this.contrast=0}BrightnessContrastEffect.prototype=Object.create(pc.PostEffect.prototype),BrightnessContrastEffect.prototype.constructor=BrightnessContrastEffect,Object.assign(BrightnessContrastEffect.prototype,{render:function(t,e,s){var r=this.device.scope;r.resolve("uBrightness").setValue(this.brightness),r.resolve("uContrast").setValue(this.contrast),r.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,s)}});var BrightnessContrast=pc.createScript("brightnessContrast");BrightnessContrast.attributes.add("brightness",{type:"number",default:0,min:-1,max:1,title:"Brightness"}),BrightnessContrast.attributes.add("contrast",{type:"number",default:0,min:-1,max:1,title:"Contrast"}),BrightnessContrast.prototype.initialize=function(){this.effect=new BrightnessContrastEffect(this.app.graphicsDevice),this.effect.brightness=this.brightness,this.effect.contrast=this.contrast,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};var SAMPLE_COUNT=15;function computeGaussian(e,t){return 1/Math.sqrt(2*Math.PI*t)*Math.exp(-e*e/(2*t*t))}function calculateBlurValues(e,t,o,r,s){e[0]=computeGaussian(0,s),t[0]=0,t[1]=0;var i,a,l=e[0];for(i=0,a=Math.floor(SAMPLE_COUNT/2);i<a;i++){var u=computeGaussian(i+1,s);e[2*i]=u,e[2*i+1]=u,l+=2*u;var h=2*i+1.5;t[4*i]=o*h,t[4*i+1]=r*h,t[4*i+2]=-o*h,t[4*i+3]=-r*h}for(i=0,a=e.length;i<a;i++)e[i]/=l}function BloomEffect(e){pc.PostEffect.call(this,e);var t={aPosition:pc.SEMANTIC_POSITION},o=["varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","    vec4 color = texture2D(uBaseTexture, vUv0);","","    gl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),r=["#define SAMPLE_COUNT "+SAMPLE_COUNT,"","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;","uniform vec2 uBlurOffsets["+SAMPLE_COUNT+"];","uniform float uBlurWeights["+SAMPLE_COUNT+"];","","void main(void)","{","    vec4 color = vec4(0.0);","    for (int i = 0; i < SAMPLE_COUNT; i++)","    {","        color += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","    }","","    gl_FragColor = color;","}"].join("\n"),s=["varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","    vec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","    vec4 base = texture2D(uBaseTexture, vUv0);","","    base *= (1.0 - clamp(bloom, 0.0, 1.0));","","    gl_FragColor = base + bloom;","}"].join("\n");this.extractShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,o,"BloomExtractShader",t),this.blurShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,r,"BloomBlurShader",t),this.combineShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,s,"BloomCombineShader",t),this.targets=[],this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(SAMPLE_COUNT),this.sampleOffsets=new Float32Array(2*SAMPLE_COUNT)}BloomEffect.prototype=Object.create(pc.PostEffect.prototype),BloomEffect.prototype.constructor=BloomEffect,BloomEffect.prototype._destroy=function(){var e;if(this.targets)for(e=0;e<this.targets.length;e++)this.targets[e].destroyTextureBuffers(),this.targets[e].destroy();this.targets.length=0},BloomEffect.prototype._resize=function(e){var t,o=e.colorBuffer.width,r=e.colorBuffer.height;if(o!==this.width||r!==this.height)for(this.width=o,this.height=r,this._destroy(),t=0;t<2;t++){var s=new pc.Texture(this.device,{name:"Bloom Texture"+t,format:pc.PIXELFORMAT_RGBA8,width:o>>1,height:r>>1,mipmaps:!1});s.minFilter=pc.FILTER_LINEAR,s.magFilter=pc.FILTER_LINEAR,s.addressU=pc.ADDRESS_CLAMP_TO_EDGE,s.addressV=pc.ADDRESS_CLAMP_TO_EDGE,s.name="pe-bloom-"+t;var i=new pc.RenderTarget({name:"Bloom Render Target "+t,colorBuffer:s,depth:!1});this.targets.push(i)}},Object.assign(BloomEffect.prototype,{render:function(e,t,o){this._resize(e);var r=this.device.scope;r.resolve("uBloomThreshold").setValue(this.bloomThreshold),r.resolve("uBaseTexture").setValue(e.colorBuffer),this.drawQuad(this.targets[0],this.extractShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),this.drawQuad(this.targets[1],this.blurShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),this.drawQuad(this.targets[0],this.blurShader),r.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),r.resolve("uBaseTexture").setValue(e.colorBuffer),this.drawQuad(t,this.combineShader,o)}});var Bloom=pc.createScript("bloom");Bloom.attributes.add("bloomIntensity",{type:"number",default:1,min:0,title:"Intensity"}),Bloom.attributes.add("bloomThreshold",{type:"number",default:.25,min:0,max:1,title:"Threshold"}),Bloom.attributes.add("blurAmount",{type:"number",default:4,min:1,title:"Blur amount"}),Bloom.prototype.initialize=function(){this.effect=new BloomEffect(this.app.graphicsDevice),this.effect.bloomThreshold=this.bloomThreshold,this.effect.blurAmount=this.blurAmount,this.effect.bloomIntensity=this.bloomIntensity;var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("attr",(function(e,t){this.effect[e]=t}),this),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect),this.effect._destroy()}))};function VignetteEffect(e){pc.PostEffect.call(this,e);var t=["uniform sampler2D uColorBuffer;","uniform float uDarkness;","uniform float uOffset;","","varying vec2 vUv0;","","void main() {","    vec4 texel = texture2D(uColorBuffer, vUv0);","    vec2 uv = (vUv0 - vec2(0.5)) * vec2(uOffset);","    gl_FragColor = vec4(mix(texel.rgb, vec3(1.0 - uDarkness), dot(uv, uv)), texel.a);","}"].join("\n");this.vignetteShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,t,"VignetteShader",{aPosition:pc.SEMANTIC_POSITION}),this.offset=1,this.darkness=1}VignetteEffect.prototype=Object.create(pc.PostEffect.prototype),VignetteEffect.prototype.constructor=VignetteEffect,Object.assign(VignetteEffect.prototype,{render:function(e,t,f){var s=this.device.scope;s.resolve("uColorBuffer").setValue(e.colorBuffer),s.resolve("uOffset").setValue(this.offset),s.resolve("uDarkness").setValue(this.darkness),this.drawQuad(t,this.vignetteShader,f)}});var Vignette=pc.createScript("vignette");Vignette.attributes.add("offset",{type:"number",default:1,min:0,title:"Offset"}),Vignette.attributes.add("darkness",{type:"number",default:1,title:"Darkness"}),Vignette.prototype.initialize=function(){this.effect=new VignetteEffect(this.app.graphicsDevice),this.effect.offset=this.offset,this.effect.darkness=this.darkness,this.on("attr",(function(e,t){this.effect[e]=t}),this);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};var Raycaster=pc.createScript("raycaster");Raycaster.attributes.add("cameraEntity",{type:"entity",title:"Camera"}),Raycaster.attributes.add("rayDistance",{type:"number",title:"Ray Distance"}),Raycaster.prototype.initialize=function(){this.pointerPosition=new pc.Vec2(0,0),this.setEventListeners("on"),this.on("destroy",(()=>this.setEventListeners("off")),this)},Raycaster.prototype.setEventListeners=function(t){pc.platform.mobile||(this.app.mouse[t](pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse[t](pc.EVENT_MOUSEDOWN,this.pointerDown,this),this.app.mouse[t](pc.EVENT_MOUSEUP,this.pointerUp,this)),this.app.touch&&(this.app.touch[t](pc.EVENT_TOUCHSTART,this.onTouchDown,this),this.app.touch[t](pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.app.touch[t](pc.EVENT_TOUCHEND,this.onTouchUp,this))},Raycaster.prototype.onMouseMove=function(t){this.pointerPosition.x=t.x,this.pointerPosition.y=t.y;var i=this.raycast();i!=this.hoveringEntity&&(this.hoveringEntity&&this.hoveringEntity.fire("input:pointerexit"),this.hoveringEntity=i,this.hoveringEntity&&this.hoveringEntity.fire("input:pointerenter"))},Raycaster.prototype.onTouchDown=function(t){this.pointerPosition.x=t.touches[0].x,this.pointerPosition.y=t.touches[0].y,this.hoveringEntity=this.raycast(),this.pointerDown()},Raycaster.prototype.onTouchMove=function(t){this.pointerPosition.x=t.touches[0].x,this.pointerPosition.y=t.touches[0].y,this.hoveringEntity=this.raycast()},Raycaster.prototype.onTouchUp=function(t){this.pointerUp(),this.hoveringEntity=null},Raycaster.prototype.raycast=function(){var t=this.cameraEntity.camera,i=this.pointerPosition,e=t.screenToWorld(i.x,i.y,t.nearClip),n=t.screenToWorld(i.x,i.y,this.rayDistance),o=this.app.systems.rigidbody.raycastFirst(e,n);return o?o.entity:null},Raycaster.prototype.pointerDown=function(){this.hoveringEntity?(this.hoveringEntity.fire("input:pointerdown"),this.selectedEntity=this.hoveringEntity):this.selectedEntity=null},Raycaster.prototype.pointerUp=function(){this.selectedEntity&&(this.selectedEntity==this.hoveringEntity&&this.selectedEntity.fire("input:click"),this.selectedEntity.fire("input:pointerup")),this.selectedEntity=null};var ScrollingTexture=pc.createScript("scrollingTexture");ScrollingTexture.attributes.add("materialAsset",{type:"asset"}),ScrollingTexture.attributes.add("speed",{type:"vec2"}),ScrollingTexture.tmpVec2=new pc.Vec2,ScrollingTexture.tmpOffset=new pc.Vec2,ScrollingTexture.prototype.initialize=function(){this.materialAsset&&(this.material=this.materialAsset.resource)},ScrollingTexture.prototype.update=function(e){var t=ScrollingTexture.tmpVec2,r=ScrollingTexture.tmpOffset;t.set(this.speed.x,this.speed.y),t.scale(e),r.copy(this.material.diffuseMapOffset),r.add(t),this.material.diffuseMapOffset=r,this.material.normalMapOffset=r,this.material.update()};var ToggleMuteSelfButton=pc.createScript("toggleMuteSelfButton");ToggleMuteSelfButton.attributes.add("voicechatEntity",{type:"entity",title:"Voice Chat"}),ToggleMuteSelfButton.attributes.add("micOnIcon",{type:"asset",title:"Mic On Icon"}),ToggleMuteSelfButton.attributes.add("micOffIcon",{type:"asset",title:"Mic Off Icon"}),ToggleMuteSelfButton.prototype.postInitialize=function(){var t=this;setTimeout((function(){t.voicechat=t.voicechatEntity.script.VoiceChat,t.updateUiIcon()}),0),this.entity.element.on("click",this.onButtonClicked,this)},ToggleMuteSelfButton.prototype.onButtonClicked=function(){this.voicechat.toggleMuteSelf(),this.updateUiIcon()},ToggleMuteSelfButton.prototype.updateUiIcon=function(){1==this.voicechat.muteSelf?this.entity.element.textureAsset=this.micOffIcon:this.entity.element.textureAsset=this.micOnIcon};var ChangeAvatarHtml=pc.createScript("changeAvatarHtml");ChangeAvatarHtml.attributes.add("avatars",{type:"json",schema:[{name:"htmlButtonId",type:"string"},{name:"avatarId",type:"string"}],array:!0}),ChangeAvatarHtml.prototype.initialize=function(){let t=Avatar.getSavedAvatar();t||(t=this.avatars[0].avatarId);for(let e=0;e<this.avatars.length;e++){let r=this.avatars[e],n=document.getElementById(r.htmlButtonId);r.avatarId==t&&this.selectAvatarByIndex(e);var a=this;n.onclick=t=>a.selectAvatarByIndex(e)}},ChangeAvatarHtml.prototype.selectAvatarByIndex=function(t){let a=this.avatars[t],e=document.getElementById(a.htmlButtonId);this.resetAllButtons(),e.style.outline="2px solid #87b4a4",Avatar.saveAvatar(a.avatarId)},ChangeAvatarHtml.prototype.resetAllButtons=function(){for(let t=0;t<this.avatars.length;t++){let a=this.avatars[t];document.getElementById(a.htmlButtonId).style.outline=""}};var RaycastButton=pc.createScript("raycastButton");RaycastButton.prototype.initialize=function(){this.element=this.entity.element,this.button=this.entity.button,this.entity.on("input:click",this.onClick,this)},RaycastButton.prototype.onClick=function(){this.element&&this.element.fire("click"),this.button&&this.button.fire("click"),this.entity.fire("click")};var RotateElement=pc.createScript("rotateElement");RotateElement.attributes.add("speedX",{type:"number",default:0}),RotateElement.attributes.add("speedY",{type:"number",default:0}),RotateElement.attributes.add("speedZ",{type:"number",default:0}),RotateElement.prototype.update=function(e){this.entity.rotateLocal(this.speedX*e,this.speedY*e,this.speedZ*e)};var LoadExternalImage=pc.createScript("loadExternalImage");LoadExternalImage.attributes.add("url",{type:"string"}),LoadExternalImage.prototype.initialize=function(){this.loadImage(this.url)},LoadExternalImage.prototype.loadImage=function(e){var t=this,a=new Image;a.src=e,a.crossOrigin="anonymous",a.onload=function(){var e=new pc.Texture(t.app.graphicsDevice);if(e.setSource(a),t.entity.element&&(t.entity.element.texture=e),t.entity.model){var n=t.entity.model.material;n.diffuseMap=e,n.update()}}};var PositionLoader=pc.createScript("positionLoader");PositionLoader.attributes.add("playerEntity",{type:"entity",title:"Player"}),PositionLoader.attributes.add("cameraPivot",{type:"entity",title:"Camera Pivot"}),PositionLoader.attributes.add("crowdEntity",{type:"entity",title:"Crowd"}),PositionLoader.savedPositions=[],PositionLoader.prototype.initialize=function(){this.setLitners("on"),this.once("destroy",(()=>this.setLitners("off")),this)},PositionLoader.prototype.setLitners=function(t){this.app[t]("scene:loaded",this.onSceneLoaded,this),this.app[t]("scene:unloading",this.onSceneUnloading,this)},PositionLoader.prototype.onSceneLoaded=function(){var t=SceneManager.currentScene;if(PositionLoader.savedPositions[t]){var i=PositionLoader.savedPositions[t];this.crowdEntity.fire("OrestisPathfinding:teleportAgentsTo",[this.playerEntity],i.pos),this.cameraPivot.setPosition(i.pos),this.playerEntity.setRotation(i.rot),this.cameraPivot.setRotation(i.rot)}},PositionLoader.prototype.onSceneUnloading=function(){var t=SceneManager.currentScene,i={};i.pos=this.playerEntity.getPosition(),i.rot=this.playerEntity.getRotation(),PositionLoader.savedPositions[t]=i};var MaterialController=pc.createScript("materialController");MaterialController.attributes.add("renderEntity",{type:"entity",title:"Render"}),MaterialController.attributes.add("materialIndex",{type:"number",title:"Material Index"}),MaterialController.attributes.add("materials",{type:"json",schema:[{name:"id",type:"string"},{name:"material",type:"asset"}],array:!0}),MaterialController.prototype.postInitialize=function(){this.dataId="matController_"+this.renderEntity.name,this.eventId="update_"+this.dataId,NetworkManager.on("network:joined",(function(){NetworkManager.getData(this.dataId,function(t){t&&this.changeMaterial(t,!1)}.bind(this)),NetworkManager.on(this.eventId,(function(t){this.changeMaterial(t,!1)}),this)}),this)},MaterialController.prototype.changeMaterial=function(t,e=!0){let a=function(t){var a=this.renderEntity.render.materialAssets;a[this.materialIndex]=t.material,this.renderEntity.render.materialAssets=a,e&&(NetworkManager.setData(this.dataId,t.id),NetworkManager.fireEvent(this.eventId,t.id))}.bind(this);for(let e=0;e<this.materials.length;e++){var r=this.materials[e];if(r.id==t)return void a(r)}};var MaterialControllerButton=pc.createScript("materialControllerButton");MaterialControllerButton.attributes.add("matControllerEntity",{type:"entity",title:"Material Controller",array:!0}),MaterialControllerButton.attributes.add("materialId",{type:"string",title:"Material Id"}),MaterialControllerButton.prototype.initialize=function(){var t=[];for(let r=0;r<this.matControllerEntity.length;r++)t[r]=this.matControllerEntity[r].script.materialController;this.entity.element.on("click",(function(){for(let r=0;r<t.length;r++){t[r].changeMaterial(this.materialId)}}),this)};var OpenLinkButton=pc.createScript("openLinkButton");OpenLinkButton.attributes.add("url",{type:"string",title:"url"}),OpenLinkButton.attributes.add("target",{type:"string",title:"url",default:"_blank"}),OpenLinkButton.prototype.initialize=function(){this.entity.element.on("click",(function(){window.open(this.url,this.target)}),this)};pc.script.createLoadingScreen((function(e){var t,a;t=["body {","    background-color: #FFFFFF;","}","","#application-splash-wrapper {","    position: absolute;","    top: 0;","    left: 0;","    height: 100%;","    width: 100%;","    background-color: #FFFFFF;","}","","#application-splash {","    position: absolute;","    top: calc(50% - 28px);","    width: 264px;","    left: calc(50% - 132px);","}","","#application-splash img {","    width: 100%;","}","","#progress-bar-container {","    margin: 20px auto 0 auto;","    height: 2px;","    width: 100%;","    background-color: #CECECE;","}","","#progress-bar {","    width: 0%;","    height: 100%;","    background-color: #094762;","}","","@media (max-width: 480px) {","    #application-splash {","        width: 170px;","        left: calc(50% - 85px);","    }","}"].join("\n"),(a=document.createElement("style")).type="text/css",a.styleSheet?a.styleSheet.cssText=t:a.appendChild(document.createTextNode(t)),document.head.appendChild(a),function(){var e=document.createElement("div");e.id="application-splash-wrapper",document.body.appendChild(e);var t=document.createElement("div");t.id="application-splash",e.appendChild(t),t.style.display="none";var a=document.createElement("img");a.src="https://pruebas.isostopy.com/Images/t_Logo_Lyvo.png",t.appendChild(a),a.onload=function(){t.style.display="block"};var o=document.createElement("div");o.id="progress-bar-container",t.appendChild(o);var p=document.createElement("div");p.id="progress-bar",o.appendChild(p)}(),e.on("preload:end",(function(){e.off("preload:progress")})),e.on("preload:progress",(function(e){var t=document.getElementById("progress-bar");t&&(e=Math.min(1,Math.max(0,e)),t.style.width=100*e+"%")})),e.on("start",(function(){var e=document.getElementById("application-splash-wrapper");e.parentElement.removeChild(e)}))}));var ChangeModels=pc.createScript("changeModels");ChangeModels.attributes.add("face_1_Base",{type:"entity"}),ChangeModels.attributes.add("face_2_Guino",{type:"entity"}),ChangeModels.attributes.add("face_3_Contento",{type:"entity"}),ChangeModels.prototype.initialize=function(){this.face_1_Base.enabled=!0,this.face_2_Guino.enabled=!1,this.face_3_Contento.enabled=!1,this.timer=0,this.nextTime=3},ChangeModels.prototype.update=function(e){this.timer+=e,this.timer>this.nextTime&&(this.timer=0,this.randomBaseVal=pc.math.random(0,3),this.randomVal=Math.ceil(this.randomBaseVal),1==this.randomVal?(this.face_1_Base.enabled=!0,this.face_2_Guino.enabled=!1,this.face_3_Contento.enabled=!1,this.nextTime=3):2==this.randomVal?(this.face_1_Base.enabled=!1,this.face_2_Guino.enabled=!0,this.face_3_Contento.enabled=!1,this.nextTime=1):(this.face_1_Base.enabled=!1,this.face_2_Guino.enabled=!1,this.face_3_Contento.enabled=!0,this.nextTime=3))};var ToggleEntityButton=pc.createScript("toggleEntityButton");ToggleEntityButton.attributes.add("toggleEntity",{type:"entity",title:"Toggle Entity"}),ToggleEntityButton.attributes.add("initialState",{type:"boolean",title:"Initial State",default:!1}),ToggleEntityButton.prototype.initialize=function(){this.toggleEntity.enabled=this.initialState,this.entity.element.on("click",this.toggle,this)},ToggleEntityButton.prototype.toggle=function(){this.toggleEntity.enabled=!this.toggleEntity.enabled};var LoadSceneOntrigger=pc.createScript("loadSceneOntrigger");LoadSceneOntrigger.attributes.add("tag",{type:"string",title:"Tag",default:"player"}),LoadSceneOntrigger.attributes.add("scene",{type:"string",title:"Target Scene"}),LoadSceneOntrigger.attributes.add("fade",{type:"boolean",title:"Fade",default:!0}),LoadSceneOntrigger.prototype.initialize=function(){this.entity.collision.on("triggerenter",this.onTriggerEnter,this),this.canTrigger=!1;setTimeout((()=>this.canTrigger=!0),100)},LoadSceneOntrigger.prototype.onTriggerEnter=function(e){this.canTrigger&&e.tags.has(this.tag)&&(this.fade?SceneManager.fadeToScene(this.scene):SceneManager.loadScene(this.scene))};var Multiplayer=pc.createScript("multiplayer");Multiplayer.attributes.add("localPlayerEntity",{title:"Local Player",type:"entity"}),Multiplayer.attributes.add("remotePlayer",{title:"Remote Player Template",type:"entity"}),Multiplayer.prototype.postInitialize=function(){this.players={},this.localPlayerAnimation=this.localPlayerEntity.script.characterAnimationController,this.timer=0,NetworkManager.on("network:joined",this.onJoinedToServer,this)},Multiplayer.prototype.onJoinedToServer=function(){this.socket=NetworkManager.socket,this.socket.emit("multiplayer:update",this.getLocalPlayerData()),this.socket.emit("multiplayer:getplayers",(t=>{Object.keys(t).forEach((e=>{if(e!=NetworkManager.id){var a=t[e];this.instantiateOtherPlayer(a)}}))})),this.socket.on("playerJoined",(t=>this.instantiateOtherPlayer(t))),this.socket.on("multiplayer:update",this.updateFromServer.bind(this)),this.socket.on("playerLeaved",(t=>{this.players[t].destroy(),delete this.players[t]}))},Multiplayer.prototype.instantiateOtherPlayer=function(t){var e=this.remotePlayer.clone();this.entity.addChild(e),e.enabled=!0,e.name=t.id,e.setPosition(0,-100,0);var a=e.findByName("user-name");a&&(a.element.text=t.name);var r=e.findByName("Avatar").script.avatar;r.currentAvatarid!=t.avatar&&r.changeAvatar(t.avatar),this.players[t.id]=e},Multiplayer.prototype.update=function(t){if(0!=NetworkManager.joined){if(this.timer>=1/120){var e=this.getLocalPlayerData();this.socket.emit("multiplayer:update",e),this.timer=0}this.timer+=t}},Multiplayer.prototype.updateFromServer=function(t){0!=NetworkManager.joined&&Object.keys(t).forEach((e=>{if(e!=NetworkManager.id){var a=t[e].multiplayerData,r=this.players[e];if(a&&r){var i=a.pos;i&&r.setPosition(i.x,i.y,i.z);var n=a.rot;n&&r.setEulerAngles(n.x,n.y,n.z);var o=a.animation,l=r.script.characterAnimationController;l&&("running"==o&&"running"!=l.currentAnimation?r.script.characterAnimationController.startRunning():"walking"==o&&"walking"!=l.currentAnimation?r.script.characterAnimationController.startWalking():"idle"==o&&"idle"!=l.currentAnimation&&r.script.characterAnimationController.stopWalking())}}}))},Multiplayer.prototype.getLocalPlayerData=function(){var t={},e=this.localPlayerEntity.getPosition();t.pos={},t.pos.x=e.x,t.pos.y=e.y,t.pos.z=e.z;var a=this.localPlayerEntity.getEulerAngles();return t.rot={},t.rot.x=a.x,t.rot.y=a.y,t.rot.z=a.z,t.animation=this.localPlayerAnimation.currentAnimation,t};var OnclickCaller=pc.createScript("onClickCaller");OnclickCaller.attributes.add("listeners",{title:"On Click()",type:"json",array:"true",schema:[{name:"targetEntity",type:"entity",title:"TargetEntity"},{name:"scriptName",type:"string",title:"Script Name",default:"scriptName"},{name:"functionName",type:"string",title:"Function Name",default:"functionName"}],default:[{targetEntity:null,scriptName:"scriptName",functionName:"functionName"}]}),OnclickCaller.prototype.initialize=function(){this.setListener("on"),this.on("enable",(()=>this.setListener("on",this))),this.on("disable",(()=>this.setListener("off",this))),this.on("destroy",(()=>this.setListener("off")),this)},OnclickCaller.prototype.setListener=function(t){this.entity.element[t]("click",this.onClick,this)},OnclickCaller.prototype.onClick=function(){this.listeners.forEach((t=>{let e=t.targetEntity.script[t.scriptName];return e?e[t.functionName]?void t.targetEntity.script[t.scriptName][t.functionName]():(console.error("El script ["+t.scriptName+"] no tiene una funcion con el nombre ["+t.functionName+"]."),!1):(console.error("La entity ["+t.targetEntity.name+"] no tiene un script con el nombre ["+t.scriptName+"]."),!1)}))},OnclickCaller.prototype.test=function(){console.log("> Esto es un test que demuestra que se esta llamando correctamente a la funcion [test()] del script [onClickCaller] de la entity ["+this.entity.name+"].")};var ScreenSharing=pc.createScript("screenSharing");ScreenSharing.prototype.postInitialize=function(){this.videoElement=document.createElement("video"),this.videoElement.muted=!0,this.canvas=document.createElement("canvas"),this.image=document.createElement("img"),NetworkManager.on("network:joined",(()=>{this.socket=NetworkManager.socket,this.socket.on("screensharing:image",(e=>{this.image.src=e})),this.image.onload=()=>{NetworkManager.fire("screensharing:image",this.image)},this.socket.on("screensharing:start",(()=>NetworkManager.fire("screensharing:start"))),this.socket.on("screensharing:end",(()=>NetworkManager.fire("screensharing:end"))),this.socket.emit("screensharing:getdata",(e=>{e&&NetworkManager.fire("screensharing:start")}))}),this),this.on("destroy",(()=>this.stopSharing()),this)},ScreenSharing.prototype.startSharing=function(){var e={video:{cursor:"always",systemAudio:"include",width:720},audio:!1};this.socket.emit("screensharing:start",(async t=>{if(t)try{var i=await navigator.mediaDevices.getDisplayMedia(e);this.videoElement.srcObject=i,this.videoElement.play(),this.sharing=!0,this.sharingRoutine(),NetworkManager.fire("screensharing:start:self")}catch(e){console.log(e),this.stopSharing()}else console.log("No puedes presentar, ya hay alguien presentando.")}))},ScreenSharing.prototype.sharingRoutine=function(){if(!this.sharing)return;this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,this.canvas.getContext("2d").drawImage(this.videoElement,0,0);var e=this.canvas.toDataURL("image/png");this.socket.emit("screensharing:image",e);let t=this;setTimeout((()=>t.sharingRoutine()),50)},ScreenSharing.prototype.stopSharing=function(){if(this.videoElement.srcObject){this.videoElement.srcObject.getTracks().forEach((e=>e.stop()))}this.videoElement.srcObject=null,this.sharing=!1,this.socket.emit("screensharing:end")};var ScreenSharingTexture=pc.createScript("screenSharingTexture");ScreenSharingTexture.attributes.add("targetTexture",{type:"asset",assetType:"texture",title:"Target Texture"}),ScreenSharingTexture.prototype.initialize=function(){this.originalSource=this.targetTexture.resource.getSource()},ScreenSharingTexture.prototype.postInitialize=function(){NetworkManager.on("screensharing:start",(()=>{this.sharing=!0})),NetworkManager.on("screensharing:image",(e=>{this.sharing&&this.targetTexture.resource.setSource(e)}),this),NetworkManager.on("screensharing:end",(()=>{this.targetTexture.resource.setSource(this.originalSource),this.sharing=!1}),this)};var ScreenSharingImage=pc.createScript("screenSharingImage");ScreenSharingImage.prototype.postInitialize=function(){this.element=this.entity.element,this.maxWidth=this.element.width,this.maxHeight=this.element.height,this.texture=new pc.Texture(this.app.graphicsDevice,{mipmaps:!1}),this.texture.minFilter=pc.FILTER_LINEAR,this.texture.magFilter=pc.FILTER_LINEAR,this.texture.addressU=pc.ADDRESS_CLAMP_TO_EDGE,this.texture.addressV=pc.ADDRESS_CLAMP_TO_EDGE,NetworkManager.on("screensharing:start",(()=>{this.originalTexture=this.element.texture,this.element.texture=this.texture}),this),NetworkManager.on("screensharing:image",(e=>{this.texture.setSource(e),this.scaleElement(e)}),this),NetworkManager.on("screensharing:end",(()=>{this.element.texture=this.originalTexture,this.element.width=this.maxWidth,this.element.height=this.maxHeight}))},ScreenSharingImage.prototype.scaleElement=function(e){let t={w:this.maxWidth,h:this.maxHeight},i=this.ruleOfThree(e.height,e.width,this.maxHeight);if(i<this.maxWidth)t.w=i;else{let i=this.ruleOfThree(e.width,e.height,this.maxWidth);t.h=i}this.element.width=t.w,this.element.height=t.h},ScreenSharingImage.prototype.ruleOfThree=function(e,t,i){return i*t/e};var ScreenSharingEntity=pc.createScript("screenSharingEntity");ScreenSharingEntity.attributes.add("behaviour",{title:"Mantener activa mientras",type:"number",enum:[{"Esta presentando alguien":0},{"No esta presentando nadie":1},{"Solo si presento yo":2},{"Solo si presenta otra persona":3}]}),ScreenSharingEntity.prototype.postInitialize=function(){this.isSomeoneSharing=!1,this.amISharing=!1,this.checkActive(),NetworkManager.on("screensharing:start",(()=>{this.isSomeoneSharing=!0,this.checkActive()})),NetworkManager.on("screensharing:start:self",(()=>{this.amISharing=!0,this.checkActive()})),NetworkManager.on("screensharing:end",(()=>{this.isSomeoneSharing=!1,this.amISharing=!1,this.checkActive()}))},ScreenSharingEntity.prototype.checkActive=function(){let e;switch(this.behaviour){case 0:e=this.isSomeoneSharing;break;case 1:e=!this.isSomeoneSharing;break;case 2:e=this.amISharing;break;case 3:e=0==this.amISharing&&1==this.isSomeoneSharing;break;default:e=!0}this.entity.enabled=e};var IngameMenuScript=pc.createScript("ingameMenuScript");IngameMenuScript.prototype.postInitialize=function(){this.menu=document.getElementById("ingame-menu"),this.openButton=document.getElementById("ingame-menu-open"),this.openButton.onclick=()=>this.openMenu(),this.closeButton=document.getElementById("ingame-menu-close"),this.closeButton.onclick=()=>this.closeMenu(),this.panels={},this.panels.options=document.getElementById("ingame-menu-options"),this.panels.profile=document.getElementById("ingame-menu-profile"),this.panels.history=document.getElementById("ingame-menu-history"),this.panels.control=document.getElementById("ingame-menu-control"),document.getElementById("ingame-menu-button-profile").onclick=()=>this.showPanel("profile"),document.getElementById("ingame-menu-button-history").onclick=()=>this.showPanel("history"),document.getElementById("ingame-menu-button-control").onclick=()=>this.showPanel("control"),this.closeMenu()},IngameMenuScript.prototype.openMenu=function(){this.menu.style.display=null,this.openButton.style.display="none"},IngameMenuScript.prototype.closeMenu=function(){this.menu.style.display="none",this.openButton.style.display=null,this.showPanel("options")},IngameMenuScript.prototype.showPanel=function(e){for(const n in this.panels)this.panels[n].style.display=n==e?null:"none"};